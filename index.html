<!DOCTYPE html>
<html lang="th">
<head>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link rel="dns-prefetch" href="//script.google.com">
  <meta charset="UTF-8" />
  <meta name="color-scheme" content="light" />
  <title>HR Incident Reporting System - BJC Big C</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  
  <!-- Tailwind via CDN (works on GitHub Pages) -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Fonts: Mitr primary, Prompt fallback -->
 <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@300;400;500;600;700&display=swap" rel="stylesheet">

  <style>
    /* ‡πÉ‡∏´‡πâ‡∏Å‡∏•‡πà‡∏≠‡∏á input ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Å‡∏ß‡πâ‡∏≤‡∏á‡πÅ‡∏ö‡∏ö‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ö‡∏ä‡πà‡∏≠‡∏á‡∏≠‡∏∑‡πà‡∏ô */
.input-base { box-sizing: border-box; }

/* ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏™‡πÑ‡∏ï‡∏•‡πå‡∏Ç‡∏≠‡∏á date/time ‡∏ö‡∏ô‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠‡πÉ‡∏´‡πâ‡∏Ñ‡∏ß‡∏ö‡∏Ñ‡∏∏‡∏°‡πÑ‡∏î‡πâ‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô text */
input[type="date"],
input[type="time"]{
  -webkit-appearance: none; /* iOS Safari */
  appearance: none;
}

/* ‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠‡∏à‡∏≠‡πÄ‡∏•‡πá‡∏Å: ‡∏Å‡∏±‡∏ô‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ä‡∏¥‡∏î‡∏Ç‡∏≠‡∏ö‡∏Ç‡∏ß‡∏≤‡πÄ‡∏û‡∏£‡∏≤‡∏∞‡∏£‡∏∞‡∏ö‡∏ö‡∏Å‡∏±‡∏ô‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡πÉ‡∏´‡πâ‡∏õ‡∏∏‡πà‡∏°‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô/‡πÄ‡∏ß‡∏•‡∏≤ */
@media (max-width: 640px){
  input[type="date"],
  input[type="time"]{
    padding-right: 0.75rem;  /* ‡πÄ‡∏ó‡πà‡∏≤‡∏Å‡∏±‡∏ö px-3 ‡∏Ç‡∏≠‡∏á Tailwind */
  }
}
    
  html, body {
  margin: 0;
  padding: 0;
  width: 100%;
  max-width: 100vw;
  overflow-x: hidden;  /* ‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡∏Ç‡πâ‡∏≤‡∏á */
}
    
    .skeleton {
  position: relative; overflow: hidden; background: #f3f4f6;
}
.skeleton::after {
  content: ""; position: absolute; inset: 0;
  transform: translateX(-100%);
  background: linear-gradient(90deg, transparent, rgba(255,255,255,.6), transparent);
  animation: loading 1.2s infinite;
}
@keyframes loading { to { transform: translateX(100%); } }
    .card-hover {
  transition: transform 0.2s ease, box-shadow 0.2s ease;
}
.card-hover:hover {
  transform: translateY(-3px);
  box-shadow: 0 8px 16px rgba(0,0,0,0.08);
}
    
    :root {
      --brand-blue-600:#2563eb; /* tailwind blue-600 */
      --brand-blue-700:#1d4ed8; /* tailwind blue-700 */
      --brand-purple-600:#7c3aed; /* tailwind purple-600 */
      --brand-pink-600:#db2777; /* tailwind pink-600 */
    }
    html, body {
  font-family: 'Prompt', system-ui, -apple-system, "Segoe UI", Roboto, sans-serif;
}

    /* Custom step styles */
    .step-indicator { transition: all .25s ease; }
    .step-indicator.active {
      background: linear-gradient(135deg, #3B82F6, #1D4ED8);
      color:#fff;
    }
    .step-indicator.completed {
      background: linear-gradient(135deg, #10B981, #059669);
      color:#fff;
    }

    /* Card hover */
    .card-hover { transition: transform .2s ease, box-shadow .2s ease; }
    .card-hover:hover { transform: translateY(-4px); box-shadow: 0 20px 40px rgba(0,0,0,.1); }

    /* Appear animations */
    .fade-in { animation: fadeIn .5s ease-in; }
    @keyframes fadeIn { from{opacity:0; transform: translateY(20px)} to{opacity:1; transform: translateY(0)} }
    .floating-element { animation: float 6s ease-in-out infinite }
    @keyframes float { 0%,100%{ transform: translateY(0) rotate(0)} 50%{ transform: translateY(-18px) rotate(180deg)} }

    /* Priority accents */
    .priority-critical { border-left: 6px solid #EF4444 }
    .priority-medium { border-left: 6px solid #F59E0B }
    .priority-low { border-left: 6px solid #10B981 }

html {
  font-size: 85%;
}
    /* ‡∏à‡∏≥‡∏Å‡∏±‡∏î‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Å‡∏ß‡πâ‡∏≤‡∏á‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î‡∏Ç‡∏≠‡∏á‡πÄ‡∏ß‡πá‡∏ö‡πÑ‡∏ã‡∏ï‡πå‡πÉ‡∏´‡πâ‡∏î‡∏π compact */
.main-container {
  max-width: 1280px;
  margin: 0 auto;
}
    
/* ===== Elegant Gray Input Style ===== */

input {
  border-color: #D1D5DB !important; /* gray-300 */
  background-color: #FFFFFF !important;
  outline: none !important;
  transition: all 0.2s ease-in-out;
}

input:focus {
  border-color: #6B7280 !important;  /* gray-500 (‡πÄ‡∏Ç‡πâ‡∏°‡∏Ç‡∏∂‡πâ‡∏ô‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏´‡∏£‡∏π) */
  box-shadow: 0 0 0 2px rgba(107, 114, 128, 0.25) !important; /* gray-500 at 25% */
  background-color: #FFFFFF !important;
}

    
  </style>
</head>
<body class="bg-gradient-to-br from-gray-50 to-blue-50 min-h-screen">
  <!-- Header -->
<nav class="w-full bg-white px-4 sm:px-8 py-3 sm:py-4 shadow-sm">
  <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3 sm:gap-6">
    
    <!-- ‡πÇ‡∏•‡πÇ‡∏Å‡πâ + ‡∏ä‡∏∑‡πà‡∏≠‡∏£‡∏∞‡∏ö‡∏ö -->
    <div class="flex items-center gap-3 sm:gap-4 justify-center sm:justify-start">
      <img src="./Logo-BJC-BigC.png"
           alt="BJC Big C Logo"
           class="h-10 sm:h-12 w-auto object-contain" />
      <div class="text-center sm:text-left">
        <h1 class="text-xl sm:text-2xl font-bold text-gray-800 leading-tight sm:whitespace-nowrap">
  HR Incident<wbr> Reporting System
</h1>
        <p class="text-xs sm:text-sm text-gray-600">‡∏£‡∏∞‡∏ö‡∏ö‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏´‡∏ï‡∏∏‡∏Å‡∏≤‡∏£‡∏ì‡πå‡∏ó‡∏£‡∏±‡∏û‡∏¢‡∏≤‡∏Å‡∏£‡∏ö‡∏∏‡∏Ñ‡∏Ñ‡∏•</p>
      </div>
    </div>

   <!-- ‡πÄ‡∏°‡∏ô‡∏π‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏î‡∏™‡∏Å‡πå‡∏ó‡πá‡∏≠‡∏õ (‡πÅ‡∏™‡∏î‡∏á‡∏ï‡∏±‡πâ‡∏á‡πÅ‡∏ï‡πà sm ‡∏Ç‡∏∂‡πâ‡∏ô‡πÑ‡∏õ) -->
<div id="desktopMenu" class="hidden sm:flex flex-wrap justify-end gap-2 sm:gap-3">
  <button onclick="showPage('report')" class="px-4 sm:px-6 py-1.5 sm:py-2 bg-blue-600 text-white rounded-xl font-semibold hover:bg-blue-700 text-sm sm:text-base">
    ‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏´‡∏ï‡∏∏‡∏Å‡∏≤‡∏£‡∏ì‡πå
  </button>
  <button onclick="showPage('history')" class="px-4 sm:px-6 py-1.5 sm:py-2 bg-green-600 text-white rounded-xl font-semibold hover:bg-green-700 text-sm sm:text-base">
    History
  </button>
  <button
  type="button"
  class="px-5 py-2.5 rounded-full text-sm font-semibold text-white bg-gray-800 hover:bg-gray-900 shadow-sm"
  onclick="openHRMonitorLogin()">
  Dashboard
</button>
  <button onclick="openHRBP()" class="px-4 sm:px-6 py-1.5 sm:py-2 bg-purple-600 text-white rounded-xl font-semibold hover:bg-purple-700 text-sm sm:text-base">
  üîê HRBP
</button>
</div>

<!-- ‡∏õ‡∏∏‡πà‡∏°‡πÅ‡∏Æ‡∏°‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÄ‡∏Å‡∏≠‡∏£‡πå‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠ (‡∏ã‡πà‡∏≠‡∏ô‡∏ö‡∏ô‡πÄ‡∏î‡∏™‡∏Å‡πå‡∏ó‡πá‡∏≠‡∏õ) -->
<button
  type="button"
  class="sm:hidden inline-flex items-center justify-center p-2 rounded-lg border border-gray-300 text-gray-700 hover:bg-gray-100"
  aria-label="‡πÄ‡∏õ‡∏¥‡∏î‡πÄ‡∏°‡∏ô‡∏π"
  onclick="toggleMobileMenu()">
  <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
          d="M4 6h16M4 12h16M4 18h16"/>
  </svg>
</button>

    <!-- ‡πÅ‡∏ú‡∏á‡πÄ‡∏°‡∏ô‡∏π‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠ (‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏ã‡πà‡∏≠‡∏ô) -->
<div id="mobileMenu" class="sm:hidden hidden bg-white border-t shadow-md px-4 py-3 space-y-2">
  <button onclick="showPage('report'); toggleMobileMenu(false)"
          class="w-full px-4 py-3 bg-blue-600 text-white rounded-xl font-semibold hover:bg-blue-700">
    ‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏´‡∏ï‡∏∏‡∏Å‡∏≤‡∏£‡∏ì‡πå
  </button>
  <button onclick="showPage('history'); toggleMobileMenu(false)"
          class="w-full px-4 py-3 bg-green-600 text-white rounded-xl font-semibold hover:bg-green-700">
    History
  </button>
  <button onclick="showPage('dashboard'); toggleMobileMenu(false)"
          class="w-full px-4 py-3 bg-gray-700 text-white rounded-xl font-semibold hover:bg-gray-800">
    Dashboard
  </button>
  <button onclick="openHRBP(); toggleMobileMenu(false)"
        class="w-full px-4 py-3 bg-purple-600 text-white rounded-xl font-semibold hover:bg-purple-700">
  üîê HRBP
</button>
</div>

    </div></nav> 

  <!-- Report Page -->
  <main id="reportPage" class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
    <!-- Stepper -->
<div class="flex items-center justify-center mb-6 sm:mb-8">
  <div class="flex flex-wrap items-center justify-center gap-3 sm:gap-4 stepper">
    <div id="step1" class="step-indicator active w-9 h-9 sm:w-12 sm:h-12
                         rounded-full flex items-center justify-center font-bold text-base sm:text-lg">1</div>
    <div class="h-1 w-10 sm:w-16 bg-gray-300 connector"></div>
    <div id="step2" class="step-indicator w-9 h-9 sm:w-12 sm:h-12
                         rounded-full bg-gray-300 flex items-center justify-center font-bold text-base sm:text-lg">2</div>
    <div class="h-1 w-10 sm:w-16 bg-gray-300 connector"></div>
    <div id="step3" class="step-indicator w-9 h-9 sm:w-12 sm:h-12
                         rounded-full bg-gray-300 flex items-center justify-center font-bold text-base sm:text-lg">3</div>
    <div class="h-1 w-10 sm:w-16 bg-gray-300 connector"></div>
    <div id="step4" class="step-indicator w-9 h-9 sm:w-12 sm:h-12
                         rounded-full bg-gray-300 flex items-center justify-center font-bold text-base sm:text-lg">4</div>
  </div>
</div>

    <!-- Step 1: Intro -->
    <section id="introStep" class="fade-in relative">
      <!-- Cute floating background shapes -->
      <div class="absolute inset-0 overflow-hidden pointer-events-none">
        <div class="floating-element absolute top-10 left-10 w-12 h-12 bg-blue-200 rounded-full opacity-20"></div>
        <div class="floating-element absolute top-20 right-20 w-10 h-10 bg-purple-200 rounded-full opacity-30" style="animation-delay:1s"></div>
        <div class="floating-element absolute bottom-20 left-20 w-8 h-8 bg-pink-200 rounded-full opacity-25" style="animation-delay:2s"></div>
        <div class="floating-element absolute bottom-10 right-10 w-14 h-14 bg-indigo-200 rounded-full opacity-20" style="animation-delay:.5s"></div>
      </div>

      <div class="relative max-w-4xl mx-auto text-center">
        <div class="relative mb-6">
          <div class="w-20 h-20 bg-gradient-to-br from-blue-500 via-purple-500 to-pink-500 rounded-full flex items-center justify-center mx-auto mb-4 shadow-xl animate-pulse">
            <div class="w-14 h-14 bg-white rounded-full flex items-center justify-center shadow-inner">
              <svg class="w-8 h-8 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
              </svg>
            </div>
          </div>
        </div>

        <h1 class="text-4xl font-extrabold leading-tight mb-3">
          <span class="bg-gradient-to-r from-blue-600 via-purple-600 to-pink-600 bg-clip-text text-transparent">‡∏£‡∏∞‡∏ö‡∏ö‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏´‡∏ï‡∏∏‡∏Å‡∏≤‡∏£‡∏ì‡πå</span><br />
          <span class="bg-gradient-to-r from-indigo-600 via-blue-600 to-cyan-600 bg-clip-text text-transparent">‡∏ó‡∏£‡∏±‡∏û‡∏¢‡∏≤‡∏Å‡∏£‡∏ö‡∏∏‡∏Ñ‡∏Ñ‡∏•</span>
        </h1>
        <p class="text-lg font-bold text-gray-700 mt-2">
  HR Incident Reporting System
</p>

        <button
          type="button"
  onclick="nextStep()"
  class="group relative bg-gradient-to-r from-indigo-500 to-pink-500 text-white font-bold py-4 px-8 rounded-2xl shadow-xl
         hover:shadow-2xl transition-all duration-300 text-lg transform hover:scale-105 hover:-translate-y-1
         w-full sm:w-auto mt-6 sm:mt-8">
  ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏´‡∏ï‡∏∏‡∏Å‡∏≤‡∏£‡∏ì‡πå
</button>
      </div>
    </section>

   <!-- Step 2: Category selection (dynamic) -->
    <section id="categoryStep" class="hidden fade-in">
      <div class="text-center mb-4">
        <h2 class="text-2xl font-bold bg-gradient-to-r from-blue-600 to-purple-600 bg-clip-text text-transparent mb-1">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á</h2>
        <p class="text-sm text-gray-600">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡πÄ‡∏´‡∏ï‡∏∏‡∏Å‡∏≤‡∏£‡∏ì‡πå‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á</p>
      </div>

      <!-- Dynamic grid here -->
      <div id="categoryGrid" class="grid grid-cols-2 lg:grid-cols-4 gap-3 max-w-4xl mx-auto"></div>

      <!-- Error -->
      <div id="categoryError" class="hidden text-center text-red-600 text-sm mt-4"></div>
    </section>

    <!-- Step 3: Sub-category -->
    <section id="subCategoryStep" class="hidden fade-in">
      <div class="text-center mb-6">
        <button onclick="goBackToCategory()" class="mb-4 px-4 py-2 border-2 border-gray-300 text-gray-700 font-semibold rounded-lg hover:bg-gray-50 text-sm">‚Üê ‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏´‡∏•‡∏±‡∏Å</button>
        <h2 id="subCategoryTitle" class="text-xl font-bold bg-gradient-to-r from-blue-600 to-purple-600 bg-clip-text text-transparent mb-1">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏¢‡πà‡∏≠‡∏¢</h2>
        <p class="text-sm text-gray-600">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏¢‡πà‡∏≠‡∏¢‡∏ó‡∏µ‡πà‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö‡πÄ‡∏´‡∏ï‡∏∏‡∏Å‡∏≤‡∏£‡∏ì‡πå</p>
      </div>
      <div id="subCategoryCards" class="grid grid-cols-2 gap-4 max-w-3xl mx-auto"></div>
    </section>

    <!-- Step 4: Details form -->
   <section id="detailsStep" class="hidden fade-in">
  <div class="max-w-4xl mx-auto bg-gradient-to-br from-white to-gray-50 rounded-2xl shadow-xl p-4 md:p-6 border border-gray-100">
    <div class="flex items-center mb-4">
      <!-- ‚úÖ ‡∏°‡∏µ id="priorityIcon" ‡πÉ‡∏´‡πâ JS ‡∏´‡∏≤‡πÄ‡∏à‡∏≠ -->
      <img id="priorityIcon" 
        src="./clipboard.png"
           alt="icon"
           class="w-12 h-12 mr-3 object-contain" />
      <div>
        <h2 id="formTitle" class="text-lg font-bold text-gray-800">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á</h2>
        <p id="formSubtitle" class="text-xs text-gray-600 mt-1">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô</p>
      </div>
    </div>
    <form onsubmit="submitReport(event)">
          
    <!-- ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏•‡∏∞‡πÄ‡∏ß‡∏•‡∏≤‡πÅ‡∏à‡πâ‡∏á : ‡∏û‡∏∑‡πâ‡∏ô‡∏´‡∏•‡∏±‡∏á‡∏Ç‡∏≤‡∏ß + ‡∏Å‡∏£‡∏≠‡∏ö‡∏ü‡πâ‡∏≤ -->
<div class="bg-blue-50/40 rounded-lg p-4 mb-4 border border-blue-200 ring-1 ring-blue-200/60">
  <h3 class="text-sm font-bold text-gray-800 mb-3 flex items-center">
    <svg class="w-4 h-4 mr-2 text-gray-700" fill="none" stroke="currentColor" viewBox="0 0 24 24">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
            d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
    </svg>
    ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏•‡∏∞‡πÄ‡∏ß‡∏•‡∏≤‡πÅ‡∏à‡πâ‡∏á
  </h3>

  <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
    <!-- ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà -->
    <div class="min-w-0">
      <div class="flex items-center justify-between mb-2">
        <label class="block text-gray-700 font-semibold mb-0.5 text-xs flex items-center gap-1">
          üìÖ ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏à‡πâ‡∏á
        </label>
        <button type="button" id="editDateBtn" onclick="toggleDateEdit()"
                class="text-xs text-blue-600 hover:text-blue-800 underline shrink-0 ml-2 whitespace-nowrap">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button>
      </div>
      <input
  type="date"
  id="reportDate"
  class="w-full px-3 py-2 bg-blue-50 border border-blue-300 rounded-lg text-gray-800 text-sm
         focus:ring-2 focus:ring-blue-400 focus:border-blue-400"
  readonly
/>
    </div>

    <!-- ‡πÄ‡∏ß‡∏•‡∏≤ -->
    <div class="min-w-0">
      <div class="flex items-center justify-between mb-2">
        <label class="block text-gray-700 font-semibold mb-0.5 text-xs flex items-center gap-1">
          ‚è∞ ‡πÄ‡∏ß‡∏•‡∏≤‡πÅ‡∏à‡πâ‡∏á
        </label>
        <button type="button" id="editTimeBtn" onclick="toggleTimeEdit()"
                class="text-xs text-blue-600 hover:text-blue-800 underline shrink-0 ml-2 whitespace-nowrap">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button>
      </div>
      <input
  type="time"
  id="reportTime"
  class="w-full px-3 py-2 bg-blue-50 border border-blue-300 rounded-lg text-gray-800 text-sm
         focus:ring-2 focus:ring-blue-400 focus:border-blue-400"
  readonly
/>
    </div>
  </div>
</div>
          
          <!-- Reporter info (demo autofill) -->
          <div class="bg-gray-50 rounded-lg p-4 mb-4 border border-gray-200">
  <h3 class="text-sm font-bold text-gray-800 mb-3 flex items-center">
    <svg class="w-4 h-4 mr-2 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
        d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
    </svg>
    ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡πÅ‡∏à‡πâ‡∏á
  </h3>

  <!-- ‡πÅ‡∏ñ‡∏ß‡∏ó‡∏µ‡πà 1 -->
  <div class="grid grid-cols-1 sm:grid-cols-2 gap-3 mb-3">
    <div>
      <label class="block text-gray-700 font-semibold mb-1 text-xs">‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•</label>
      <input type="text" id="employeeName" readonly
        class="w-full px-3 py-2 bg-gray-100 border border-gray-300 rounded-lg text-gray-700 text-sm cursor-not-allowed" />
    </div>
    <div>
      <label class="block text-gray-700 font-semibold mb-1 text-xs">‡∏£‡∏´‡∏±‡∏™‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô</label>
      <input type="text" id="employeeCode" readonly
        class="w-full px-3 py-2 bg-gray-100 border border-gray-300 rounded-lg text-gray-700 text-sm cursor-not-allowed" />
    </div>
  </div>

  <!-- ‡πÅ‡∏ñ‡∏ß‡∏ó‡∏µ‡πà 2 -->
  <div class="grid grid-cols-1 sm:grid-cols-2 gap-3 mb-3">
    <div>
      <label class="block text-gray-700 font-semibold mb-1 text-xs">Company</label>
      <input type="text" id="employeeCompany" readonly
        class="w-full px-3 py-2 bg-gray-100 border border-gray-300 rounded-lg text-gray-700 text-sm cursor-not-allowed" />
    </div>
    <div>
      <label class="block text-gray-700 font-semibold mb-1 text-xs">Division</label>
      <input type="text" id="employeeDivision" readonly
        class="w-full px-3 py-2 bg-gray-100 border border-gray-300 rounded-lg text-gray-700 text-sm cursor-not-allowed" />
    </div>
  </div>

  <!-- ‡πÅ‡∏ñ‡∏ß‡∏ó‡∏µ‡πà 3 -->
  <div class="grid grid-cols-1 sm:grid-cols-2 gap-3 mb-3">
    <div>
      <label class="block text-gray-700 font-semibold mb-1 text-xs">Department</label>
      <input type="text" id="employeeDepartment" readonly
        class="w-full px-3 py-2 bg-gray-100 border border-gray-300 rounded-lg text-gray-700 text-sm cursor-not-allowed" />
    </div>
    <div>
      <label class="block text-gray-700 font-semibold mb-1 text-xs">Store</label>
      <input type="text" id="employeeStore" readonly
        class="w-full px-3 py-2 bg-gray-100 border border-gray-300 rounded-lg text-gray-700 text-sm cursor-not-allowed" />
    </div>
  </div>

  <!-- ‡πÅ‡∏ñ‡∏ß‡∏ó‡∏µ‡πà 4 -->
  <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
    <div>
      <label class="block text-gray-700 font-semibold mb-1 text-xs">Email</label>
      <input type="email" id="employeeEmail" readonly
        class="w-full px-3 py-2 bg-gray-100 border border-gray-300 rounded-lg text-gray-700 text-sm cursor-not-allowed" />
    </div>
    <div>
      <label class="block text-gray-700 font-semibold mb-1 text-xs">Contact number</label>
      <input type="tel" id="employeePhone" readonly
        class="w-full px-3 py-2 bg-gray-100 border border-gray-300 rounded-lg text-gray-700 text-sm cursor-not-allowed" />
    </div>
  </div>
</div>
              
         <!-- HR Business Partner ‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà (‡∏ó‡∏≥‡πÉ‡∏´‡πâ‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡∏≤/‡∏Ç‡∏ô‡∏≤‡∏î‡πÄ‡∏ó‡πà‡∏≤‡∏Å‡∏±‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡πÅ‡∏à‡πâ‡∏á) -->
<div class="bg-gray-50 rounded-lg p-4 mb-6 border border-gray-200">  <!-- mb-6 => ‡πÄ‡∏ß‡πâ‡∏ô‡∏ä‡πà‡∏≠‡∏á‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡∏Å‡∏•‡πà‡∏≠‡∏á‡∏ô‡∏µ‡πâ‡∏Å‡∏±‡∏ö‡∏™‡πà‡∏ß‡∏ô‡∏ñ‡∏±‡∏î‡πÑ‡∏õ -->
  <h4 class="text-gray-800 font-semibold mb-3 text-sm flex items-center gap-2">
    HR Business Partner ‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà
  </h4>

  <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
    <div>
      <label class="block text-gray-700 font-semibold mb-1 text-xs">HRBP Name</label>
      <input type="text" id="assignedHRBP" readonly
             class="w-full px-3 py-2 bg-gray-100 border border-gray-300 rounded-lg text-gray-700 text-sm cursor-not-allowed" />
    </div>
    <div>
      <label class="block text-gray-700 font-semibold mb-1 text-xs">HRBP Email</label>
      <input type="text" id="assignedHRBPEmail" readonly
             class="w-full px-3 py-2 bg-gray-100 border border-gray-300 rounded-lg text-gray-700 text-sm cursor-not-allowed" />
    </div>
  </div>
</div>

          <!-- Incident details -->
          <div class="bg-yellow-50 rounded-lg p-4 mt-4 mb-4 border border-yellow-200">
  <h3 class="text-sm font-bold text-gray-800 mb-3 flex items-center">
    <svg class="w-4 h-4 mr-2 text-yellow-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
    </svg>
    ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡πÄ‡∏´‡∏ï‡∏∏‡∏Å‡∏≤‡∏£‡∏ì‡πå
  </h3>

  <!-- ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î -->
  <div class="mb-3">
    <label class="block text-gray-700 font-semibold mb-1 text-xs">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡πÄ‡∏´‡∏ï‡∏∏‡∏Å‡∏≤‡∏£‡∏ì‡πå *</label>
    <textarea id="incidentDetail" required rows="4"
      class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent text-sm"
      placeholder="‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏∞‡∏ö‡∏∏‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡πÄ‡∏´‡∏ï‡∏∏‡∏Å‡∏≤‡∏£‡∏ì‡πå‡πÉ‡∏´‡πâ‡∏ä‡∏±‡∏î‡πÄ‡∏à‡∏ô ‡πÄ‡∏ä‡πà‡∏ô ‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡∏¥‡∏î‡πÄ‡∏´‡∏ï‡∏∏, ‡∏ú‡∏π‡πâ‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Ç‡πâ‡∏≠‡∏á, ‡∏™‡∏≤‡πÄ‡∏´‡∏ï‡∏∏"></textarea>
  </div>

  <!-- Format + Location -->
<div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
  
  <!-- Format -->
<div>
  <label class="block text-gray-700 font-semibold mb-1 text-xs">Format</label>

  <!-- ‡∏Å‡∏•‡πà‡∏≠‡∏á‡∏ô‡∏µ‡πâ‡∏Ñ‡∏∏‡∏°‡πÄ‡∏â‡∏û‡∏≤‡∏∞ input + ‡∏õ‡∏∏‡πà‡∏° + dropdown -->
  <div class="relative">
    <input
      type="text"
      id="locationFormat"
      class="w-full px-3 py-2 pr-9 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent text-sm"
      placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏ä‡∏±‡πâ‡∏ô/‡∏≠‡∏≤‡∏Ñ‡∏≤‡∏£/‡πÇ‡∏ã‡∏ô‡∏ú‡∏•‡∏¥‡∏ï"
      autocomplete="off"
      oninput="typeaheadFormat(this.value)"
      onclick="toggleFormatDropdown(true)"
    />
    <!-- ‚ñº ‡∏õ‡∏∏‡πà‡∏° Format --> 
    <button
      id="formatToggleBtn"
      type="button"
      class="absolute right-2 top-1/2 -translate-y-1/2 transform px-2 py-1 text-xs border rounded hover:bg-gray-50"
      onclick="event.stopPropagation(); toggleFormatDropdown(true)"
      aria-label="‡πÅ‡∏™‡∏î‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ Format"
    >‚ñº</button>

    <div id="formatDropdown"
         class="hidden absolute z-10 w-full bg-white border border-gray-300 rounded-lg shadow-lg mt-1 max-h-40 overflow-y-auto"></div>
  </div>
</div>

  <!-- Location -->
<div>
  <label class="block text-gray-700 font-semibold mb-1 text-xs">Location</label>

  <!-- ‡∏Å‡∏•‡πà‡∏≠‡∏á‡∏ô‡∏µ‡πâ‡∏Ñ‡∏∏‡∏°‡πÄ‡∏â‡∏û‡∏≤‡∏∞ input + ‡∏õ‡∏∏‡πà‡∏° + dropdown -->
  <div class="relative">
    <input
      type="text"
      id="locationInput"
      class="w-full px-3 py-2 pr-9 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent text-sm"
      placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà..."
      autocomplete="off"
      oninput="typeaheadLocation(this.value)"
      onclick="toggleLocationDropdown(true)"
    />
    <button
      id="locationToggleBtn"
      type="button"
      class="absolute right-2 top-1/2 -translate-y-1/2 transform px-2 py-1 text-xs border rounded hover:bg-gray-50"
      onclick="toggleLocationDropdown(true)"
      aria-label="‡πÅ‡∏™‡∏î‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ Location"
    >‚ñº</button>
    <div id="locationDropdown"
         class="hidden absolute z-10 w-full bg-white border border-gray-300 rounded-lg shadow-lg mt-1 max-h-40 overflow-y-auto"></div>
  </div>
</div>

    <!-- ‡∏ú‡∏π‡πâ‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Ç‡πâ‡∏≠‡∏á (‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏¥‡∏°) -->
<div class="sm:col-span-2">
  <label class="block text-gray-700 font-semibold mb-1 text-xs">‡∏ú‡∏π‡πâ‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Ç‡πâ‡∏≠‡∏á</label>
  <input type="text"
    class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent text-sm"
    placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Ç‡πâ‡∏≠‡∏á (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)" />
</div>
  </div>

  <!-- ‡πÅ‡∏ô‡∏ö‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û -->
  <div class="mt-4">
    <label class="block text-gray-700 font-semibold mb-1 text-xs">‡πÅ‡∏ô‡∏ö‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)</label>
    <input type="file" id="incidentPhotos" accept="image/*" multiple
      class="block w-full text-sm text-gray-700 file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:bg-blue-600 file:text-white hover:file:bg-blue-700" />
    <!-- Preview -->
    <div id="photoPreview" class="mt-3 grid grid-cols-3 sm:grid-cols-4 md:grid-cols-6 gap-2"></div>
    <p class="text-xs text-gray-500 mt-1">‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡πÑ‡∏ü‡∏•‡πå .jpg, .png, .heic ‡∏Ç‡∏ô‡∏≤‡∏î‡πÑ‡∏°‡πà‡πÄ‡∏Å‡∏¥‡∏ô 5MB ‡∏ï‡πà‡∏≠‡πÑ‡∏ü‡∏•‡πå (‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î 10 ‡∏£‡∏π‡∏õ)</p>
  </div>
</div>

          <div class="flex gap-3">
            <button type="button" onclick="goBack()" class="px-4 py-3 border-2 border-gray-300 text-gray-700 font-semibold rounded-lg hover:bg-gray-50 text-sm"> ‡∏¢‡πâ‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö</button>
            <button type="submit" id="submitBtn"
 class="flex-1 bg-gradient-to-r from-blue-600 to-blue-700 hover:from-blue-700 hover:to-blue-800
         text-white font-bold py-3 px-4 rounded-lg shadow-lg hover:shadow-xl text-sm">
  ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏´‡∏ï‡∏∏‡∏Å‡∏≤‡∏£‡∏ì‡πå
</button>
          </div>
        </form>
      </div>
    </section>

    <!-- Step 5: Success -->
    <section id="successStep" class="hidden fade-in max-w-md mx-auto">
  <div class="bg-white rounded-3xl shadow-xl p-8 text-center">
    <div class="w-20 h-20 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-5">
      <svg class="w-10 h-10 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
      </svg>
    </div>

    <h2 class="text-2xl font-extrabold text-gray-900 mb-2">‡∏™‡πà‡∏á‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à</h2>
    <p class="text-gray-600 mb-6 leading-relaxed">
      ‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏•‡πâ‡∏ß<br/>HRBP ‡∏à‡∏∞‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠‡∏Å‡∏•‡∏±‡∏ö‡∏†‡∏≤‡∏¢‡πÉ‡∏ô 24 ‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á
    </p>

    <div class="bg-blue-50 rounded-xl px-5 py-4 mb-6 border border-blue-100">
      <p class="text-blue-800 text-sm">
        ‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏•‡∏Ç‡∏≠‡πâ‡∏≤‡∏á‡∏≠‡∏¥‡∏á: <span class="font-extrabold" id="referenceNumber">HR-2025-xxx</span>
      </p>
    </div>

    <button onclick="resetForm()"
      class="w-full bg-blue-600 hover:bg-blue-700 text-white font-extrabold py-3 rounded-xl shadow-lg">
      ‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏´‡∏ï‡∏∏‡∏Å‡∏≤‡∏£‡∏ì‡πå‡πÉ‡∏´‡∏°‡πà
    </button>
  </div>
</section>
    
    </main>

  <!-- History Page -->
  <section id="historyPage" class="hidden max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 py-6">
    <div class="text-center mb-4">
  <h1 class="text-2xl sm:text-3xl font-bold bg-gradient-to-r from-green-600 to-blue-600 bg-clip-text text-transparent mb-1">
    ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏´‡∏ï‡∏∏‡∏Å‡∏≤‡∏£‡∏ì‡πå
  </h1>
  <p class="text-gray-600 text-sm sm:text-base">‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÅ‡∏•‡∏∞‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÄ‡∏Ñ‡∏™‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì</p>
</div>

    <!-- Login -->
    <div id="historyLoginSection" class="bg-white rounded-xl shadow-lg p-6 mb-6 max-w-xl mx-auto">
      <div class="text-center mb-4">
        <div class="w-12 h-12 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-3">
          <svg class="w-6 h-6 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
        </div>
        <h3 class="text-lg sm:text-xl font-bold text-gray-800 mb-1">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏ï‡∏±‡∏ß‡∏ï‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥</h3>
<p class="text-gray-600 text-sm sm:text-base">
  ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏´‡∏±‡∏™‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏Ç‡πâ‡∏≤‡∏î‡∏π‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏´‡∏ï‡∏∏‡∏Å‡∏≤‡∏£‡∏ì‡πå
</p>
      </div>
      <form onsubmit="verifyHistoryAccess(event)" class="max-w-sm mx-auto">
  <div class="mb-4">
    <label class="block text-gray-700 font-semibold mb-2 flex items-center justify-center text-sm">
      ‡∏£‡∏´‡∏±‡∏™‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô
    </label>
    <input type="text" id="historyEmployeeId" required
      class="w-full px-3 py-2 border border-green-200 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-green-500 text-base text-center"
      placeholder="‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà‡∏£‡∏´‡∏±‡∏™‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô" />
  </div>
  <button type="submit"
    class="w-full px-4 py-2 bg-gradient-to-r from-green-600 to-green-700 hover:from-green-700 hover:to-green-800 text-white font-semibold rounded-lg shadow-md text-sm sm:text-base">
    ‡πÄ‡∏Ç‡πâ‡∏≤‡∏î‡∏π‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥
  </button>
</form>
    </div>

    <!-- History content -->
    <div id="historyContent" class="hidden">
      <div class="bg-white rounded-xl shadow-lg p-6 mb-6 max-w-xl mx-auto">
  <div class="max-w-md mx-auto">
    <label class="block text-gray-700 font-semibold mb-2 text-center text-sm">
      üîç ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏î‡πâ‡∏ß‡∏¢‡∏£‡∏´‡∏±‡∏™‡πÄ‡∏Ñ‡∏™
    </label>
    <div class="flex gap-2">
      <input type="text" id="caseSearch"
        class="flex-1 px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-green-500 text-sm sm:text-base"
        placeholder="‡πÄ‡∏ä‡πà‡∏ô HR-2025-001" />
      <button onclick="searchByCase()"
        class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 font-semibold text-sm sm:text-base">
        ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤
      </button>
    </div>
  </div>
</div>
      <div id="searchResults" class="hidden max-w-4xl mx-auto">
  <h3 class="text-xl font-bold text-gray-800 mb-2">‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤</h3>

  <!-- ‡∏õ‡∏∏‡πà‡∏°‡∏Å‡∏£‡∏≠‡∏á‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÄ‡∏Ñ‡∏™ -->
  <div class="flex flex-wrap items-center gap-2 mb-3 text-xs sm:text-sm">
    <span class="text-gray-600 mr-2">‡∏Å‡∏£‡∏≠‡∏á‡∏ï‡∏≤‡∏°‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞:</span>

    <!-- ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î (‡∏Ñ‡πà‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô) -->
    <button
      type="button"
      class="history-filter-btn px-3 py-1.5 rounded-full border border-gray-200 bg-blue-600 text-white font-medium"
      data-history-filter="ALL">
      ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
    </button>

    <!-- ‡∏£‡∏≠‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö -->
    <button
      type="button"
      class="history-filter-btn px-3 py-1.5 rounded-full border border-gray-200 bg-gray-100 text-gray-700 font-medium"
      data-history-filter="‡∏£‡∏≠‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö">
      ‡∏£‡∏≠‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö
    </button>

    <!-- ‡∏£‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£ -->
    <button
      type="button"
      class="history-filter-btn px-3 py-1.5 rounded-full border border-gray-200 bg-gray-100 text-gray-700 font-medium"
      data-history-filter="‡∏£‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£">
      ‡∏£‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£
    </button>
 
    <!-- ‡∏õ‡∏¥‡∏î‡πÄ‡∏Ñ‡∏™ (‡∏à‡∏∞‡πÑ‡∏õ‡πÅ‡∏°‡πá‡∏õ‡∏Å‡∏±‡∏ö‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÉ‡∏ô‡∏ä‡∏µ‡∏ï = ‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô) -->
    <button
      type="button"
      class="history-filter-btn px-3 py-1.5 rounded-full border border-gray-200 bg-gray-100 text-gray-700 font-medium"
      data-history-filter="‡∏õ‡∏¥‡∏î‡πÄ‡∏Ñ‡∏™">
      ‡∏õ‡∏¥‡∏î‡πÄ‡∏Ñ‡∏™
    </button>
  </div>

  <div id="resultsContainer" class="space-y-3"></div>
</div>
  </section>

  <!-- Dashboard Page (static demo) -->
  <section id="dashboardPage" class="hidden max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
    <div class="text-center mb-10">
      <div class="w-20 h-20 bg-gradient-to-br from-blue-500 to-purple-600 rounded-2xl flex items-center justify-center mx-auto mb-6 shadow-xl">
        <svg class="w-10 h-10 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"/></svg>
      </div>
      <h1 class="text-4xl font-bold bg-gradient-to-r from-blue-600 to-purple-600 bg-clip-text text-transparent mb-2">Dashboard</h1>
      <p class="text-gray-600">‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏´‡∏ï‡∏∏‡∏Å‡∏≤‡∏£‡∏ì‡πå‡πÅ‡∏•‡∏∞‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</p>
    </div>

    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-8 mb-10">
      <div class="bg-gradient-to-br from-blue-50 to-blue-100 rounded-2xl shadow-xl p-8 border border-blue-200 text-center">
        <div class="w-16 h-16 bg-gradient-to-br from-blue-500 to-blue-600 rounded-2xl flex items-center justify-center mx-auto mb-6 shadow-lg">
          <svg class="w-8 h-8 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/></svg>
        </div>
        <p class="text-4xl font-black text-gray-800 mb-2">24</p>
        <p class="text-blue-700 font-semibold">‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</p>
        <p class="text-blue-600 text-sm">Total Reports</p>
      </div>
      <div class="bg-gradient-to-br from-red-50 to-red-100 rounded-2xl shadow-xl p-8 border border-red-200 text-center">
        <div class="w-16 h-16 bg-gradient-to-br from-red-500 to-red-600 rounded-2xl flex items-center justify-center mx-auto mb-6 shadow-lg">
          <svg class="w-8 h-8 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01M5.062 19h13.876"/></svg>
        </div>
        <p class="text-4xl font-black text-gray-800 mb-2">8</p>
        <p class="text-red-700 font-semibold">‡∏î‡πà‡∏ß‡∏ô‡∏°‡∏≤‡∏Å</p>
        <p class="text-red-600 text-sm">Critical Priority</p>
      </div>
      <div class="bg-gradient-to-br from-orange-50 to-orange-100 rounded-2xl shadow-xl p-8 border border-orange-200 text-center">
        <div class="w-16 h-16 bg-gradient-to-br from-orange-500 to-orange-600 rounded-2xl flex items-center justify-center mx-auto mb-6 shadow-lg">
          <svg class="w-8 h-8 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"/></svg>
        </div>
        <p class="text-4xl font-black text-gray-800 mb-2">5</p>
        <p class="text-orange-700 font-semibold">‡∏î‡πà‡∏ß‡∏ô</p>
        <p class="text-orange-600 text-sm">High Priority</p>
      </div>
      <div class="bg-gradient-to-br from-green-50 to-green-100 rounded-2xl shadow-xl p-8 border border-green-200 text-center">
        <div class="w-16 h-16 bg-gradient-to-br from-green-500 to-green-600 rounded-2xl flex items-center justify-center mx-auto mb-6 shadow-lg">
          <svg class="w-8 h-8 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
        </div>
        <p class="text-4xl font-black text-gray-800 mb-2">11</p>
        <p class="text-green-700 font-semibold">‡∏õ‡∏≤‡∏ô‡∏Å‡∏•‡∏≤‡∏á</p>
        <p class="text-green-600 text-sm">Medium Priority</p>
      </div>
    </div>

    <!-- Factory tiles (static demo) -->
    <div class="bg-white rounded-3xl shadow-2xl p-10 border border-gray-100">
      <div class="text-center mb-8">
        <h3 class="text-2xl font-bold text-gray-800">‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡∏ï‡∏≤‡∏°‡πÇ‡∏£‡∏á‡∏á‡∏≤‡∏ô/‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà</h3>
        <p class="text-gray-600">‡∏Ñ‡∏•‡∏¥‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡πÅ‡∏ï‡πà‡∏•‡∏∞‡πÇ‡∏£‡∏á‡∏á‡∏≤‡∏ô (‡πÄ‡∏î‡πÇ‡∏°)</p>
      </div>
      <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-5 gap-4">
        <button onclick="viewFactoryDetails('ladkrabang')" class="bg-gradient-to-br from-blue-50 to-blue-100 rounded-xl p-4 border border-blue-200 hover:shadow-lg">‡∏•‡∏≤‡∏î‡∏Å‡∏£‡∏∞‡∏ö‡∏±‡∏á ‚Ä¢ 9</button>
        <button onclick="viewFactoryDetails('bangna')" class="bg-gradient-to-br from-green-50 to-green-100 rounded-xl p-4 border border-green-200 hover:shadow-lg">‡∏ö‡∏≤‡∏á‡∏ô‡∏≤ ‚Ä¢ 6</button>
        <button onclick="viewFactoryDetails('samutprakarn')" class="bg-gradient-to-br from-purple-50 to-purple-100 rounded-xl p-4 border border-purple-200 hover:shadow-lg">‡∏™‡∏°‡∏∏‡∏ó‡∏£‡∏õ‡∏£‡∏≤‡∏Å‡∏≤‡∏£ ‚Ä¢ 4</button>
        <button onclick="viewFactoryDetails('chonburi')" class="bg-gradient-to-br from-orange-50 to-orange-100 rounded-xl p-4 border border-orange-200 hover:shadow-lg">‡∏ä‡∏•‡∏ö‡∏∏‡∏£‡∏µ ‚Ä¢ 3</button>
        <button onclick="viewFactoryDetails('headquarters')" class="bg-gradient-to-br from-gray-50 to-gray-100 rounded-xl p-4 border border-gray-200 hover:shadow-lg">‡∏™‡∏≥‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡πÉ‡∏´‡∏ç‡πà ‚Ä¢ 2</button>
      </div>
    </div>
  </section>
    
      <!-- HRBP Page -->
  <section id="hrbpPage" class="hidden max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
    <div class="text-center mb-6">
      <div class="w-20 h-20 bg-gradient-to-br from-purple-500 to-blue-600 rounded-2xl flex items-center justify-center mx-auto mb-4 shadow-xl">
        <svg class="w-10 h-10 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z" />
        </svg>
      </div>
      <h1 class="text-2xl sm:text-3xl font-bold bg-gradient-to-r from-purple-600 to-blue-600 bg-clip-text text-transparent mb-1">
        HRBP Monitor
      </h1>
      <p class="text-gray-600 text-sm sm:text-base">
        ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏Ñ‡∏™‡∏ó‡∏µ‡πà‡∏Ñ‡∏∏‡∏ì‡∏£‡∏±‡∏ö‡∏ú‡∏¥‡∏î‡∏ä‡∏≠‡∏ö
      </p>
    </div>

    <!-- ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• HRBP ‡∏ó‡∏µ‡πà‡∏•‡πá‡∏≠‡∏Å‡∏≠‡∏¥‡∏ô -->
    <div class="bg-white rounded-2xl shadow-md border border-gray-100 p-4 sm:p-5 flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3">
      <div>
        <p class="text-sm text-gray-500">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡πÉ‡∏ô‡∏ô‡∏≤‡∏°</p>
        <p class="text-base sm:text-lg font-semibold text-gray-800" id="hrbpHeaderName">-</p>
        <p class="text-xs sm:text-sm text-gray-500" id="hrbpHeaderEmail">-</p>
      </div>
      <div class="flex gap-2">
        <button type="button"
                class="px-3 py-2 text-xs sm:text-sm rounded-lg border border-gray-300 text-gray-700 hover:bg-gray-50"
                onclick="resetHRBPPage()">
          üîÑ ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î
        </button>
        <button type="button"
                class="px-3 py-2 text-xs sm:text-sm rounded-lg border border-red-300 text-red-600 hover:bg-red-50"
                onclick="logoutHRBP()">
          ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö
        </button>
      </div>
    </div>

    <!-- ‡∏ï‡∏±‡∏ß‡∏Å‡∏£‡∏≠‡∏á‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÄ‡∏Ñ‡∏™ HRBP -->
<div class="mt-4 mb-4 flex flex-wrap items-center gap-2">
  <span class="text-xs sm:text-sm text-gray-500 mr-1">
    ‡∏Å‡∏£‡∏≠‡∏á‡∏ï‡∏≤‡∏°‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞:
  </span>

  <!-- ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î (‡πÄ‡∏ó‡∏≤) -->
  <button type="button"
          class="px-3 py-1.5 text-xs sm:text-sm rounded-full border bg-white text-gray-700 hover:bg-gray-50 border-gray-300"
          data-hrbp-filter-btn
          data-filter-value="ALL"
          data-color="gray"
          onclick="setHRBPFilter('ALL')">
    ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
  </button>

  <!-- ‡∏£‡∏≠‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö (‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏á) -->
  <button type="button"
          class="px-3 py-1.5 text-xs sm:text-sm rounded-full border bg-white text-yellow-700 hover:bg-yellow-50 border-yellow-300"
          data-hrbp-filter-btn
          data-filter-value="‡∏£‡∏≠‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö"
          data-color="yellow"
          onclick="setHRBPFilter('‡∏£‡∏≠‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö')">
    ‡∏£‡∏≠‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö
  </button>

  <!-- ‡∏£‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£ (‡∏™‡πâ‡∏°) -->
  <button type="button"
          class="px-3 py-1.5 text-xs sm:text-sm rounded-full border bg-white text-orange-700 hover:bg-orange-50 border-orange-300"
          data-hrbp-filter-btn
          data-filter-value="‡∏£‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£"
          data-color="orange"
          onclick="setHRBPFilter('‡∏£‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£')">
    ‡∏£‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£
  </button>

  <!-- ‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô-‡∏õ‡∏¥‡∏î‡πÄ‡∏Ñ‡∏™ (‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß) -->
  <button type="button"
          class="px-3 py-1.5 text-xs sm:text-sm rounded-full border bg-white text-green-700 hover:bg-green-50 border-green-300"
          data-hrbp-filter-btn
          data-filter-value="‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô-‡∏õ‡∏¥‡∏î‡πÄ‡∏Ñ‡∏™"
          data-color="green"
          onclick="setHRBPFilter('‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô-‡∏õ‡∏¥‡∏î‡πÄ‡∏Ñ‡∏™')">
    ‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô-‡∏õ‡∏¥‡∏î‡πÄ‡∏Ñ‡∏™
  </button>
</div>

    <!-- ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏Ñ‡∏™ HRBP -->
<div id="hrbpCasesContainer" class="space-y-3">
  <!-- ‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡πÄ‡∏ï‡∏¥‡∏°‡∏î‡πâ‡∏ß‡∏¢ JavaScript -->
</div>

<!-- Pagination HRBP -->
<div id="hrbpPagination"
     class="mt-4 flex items-center justify-between text-xs sm:text-sm text-gray-600">
  <!-- ‡∏õ‡∏∏‡πà‡∏°‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏´‡∏ô‡πâ‡∏≤ / ‡∏ï‡∏±‡∏ß‡∏ö‡∏≠‡∏Å‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡πÄ‡∏ï‡∏¥‡∏°‡∏î‡πâ‡∏ß‡∏¢ JavaScript -->
</div>
  </section>

  <!-- Employee Login Modal -->
  <div id="employeeModal" class="hidden fixed inset-0 bg-black/50 flex items-center justify-center z-50">
    <div class="bg-white rounded-xl shadow-2xl p-8 max-w-md w-full mx-4">
      <div class="text-center mb-6">
        <div class="w-16 h-16 bg-blue-100 rounded-full flex items-center justify-center mx-auto mb-4">
          <svg class="w-8 h-8 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/></svg>
        </div>
        <h3 class="text-xl font-bold text-gray-800 mb-1">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏ï‡∏±‡∏ß‡∏ï‡∏ô‡∏ú‡∏π‡πâ‡πÅ‡∏à‡πâ‡∏á</h3>
        <p class="text-gray-600">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏´‡∏±‡∏™‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏ï‡∏±‡∏ß‡∏ï‡∏ô</p>
      </div>
      <form onsubmit="verifyEmployee(event)">
        <div class="mb-6">
          <label class="block text-gray-700 font-semibold mb-2">‡∏£‡∏´‡∏±‡∏™‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô</label>
          <input type="text" id="employeeId" required class="w-full px-4 py-3 border-2 border-blue-200 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-blue-500 text-lg" placeholder="‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏´‡∏±‡∏™‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô" />
        </div>
        <div class="flex gap-3">
          <button type="button" onclick="closeEmployeeModal()" class="flex-1 px-6 py-3 border-2 border-gray-300 text-gray-700 font-semibold rounded-xl hover:bg-gray-50">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
          <button type="submit" class="flex-1 px-6 py-3 bg-gradient-to-r from-blue-600 to-blue-700 hover:from-blue-700 hover:to-blue-800 text-white font-bold rounded-xl shadow-lg">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏ï‡∏±‡∏ß‡∏ï‡∏ô</button>
        </div>
      </form>
    </div>
  </div>

  <!-- HRBP Login Modal -->
  <div id="hrbpModal" class="hidden fixed inset-0 bg-black/50 flex items-center justify-center z-50">
    <div class="bg-white rounded-xl shadow-2xl p-8 max-w-md w-full mx-4">
      <div class="text-center mb-6">
        <div class="w-16 h-16 bg-purple-100 rounded-full flex items-center justify-center mx-auto mb-4">
          <svg class="w-8 h-8 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z"/></svg>
        </div>
        <h3 class="text-xl font-bold text-gray-800 mb-1">HRBP Monitor</h3>
        <p class="text-gray-600">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÄ‡∏Ñ‡∏™‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö HRBP</p>
      </div>
      <form onsubmit="verifyHRBP(event)">
        <div class="mb-6">
          <label class="block text-gray-700 font-semibold mb-2">‡∏£‡∏´‡∏±‡∏™‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô HRBP</label>
          <input type="text" id="hrbpId" required class="w-full px-4 py-3 border-2 border-purple-200 rounded-xl focus:ring-2 focus:ring-purple-500 focus:border-purple-500 text-lg text-center" placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏´‡∏±‡∏™‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô HRBP" />
        </div>
        <div class="flex gap-3">
          <button type="button" onclick="closeHRBPModal()" class="flex-1 px-6 py-3 border-2 border-gray-300 text-gray-700 font-semibold rounded-xl hover:bg-gray-50">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
          <button type="submit" class="flex-1 px-6 py-3 bg-gradient-to-r from-purple-600 to-purple-700 hover:from-purple-700 hover:to-purple-800 text-white font-bold rounded-xl shadow-lg">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</button>
        </div>
      </form>
    </div>
  </div>
    
    <!-- HR Monitor Login Modal -->
<div id="hrMonitorLoginModal"
     class="hidden fixed inset-0 bg-black/50 flex items-center justify-center z-50">
  <div class="bg-white rounded-xl shadow-2xl p-8 max-w-md w-full mx-4">
    <div class="text-center mb-6">
      <!-- ‡πÑ‡∏≠‡∏Ñ‡∏≠‡∏ô‡πÅ‡∏ö‡∏ö‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ö HRBP ‡πÅ‡∏ï‡πà‡πÇ‡∏ó‡∏ô‡∏™‡∏µ‡∏ü‡πâ‡∏≤ -->
      <div class="w-16 h-16 bg-blue-50 border border-blue-200 rounded-full flex items-center justify-center mx-auto mb-4">
        <svg class="w-8 h-8 text-blue-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path
            stroke-linecap="round"
            stroke-linejoin="round"
            stroke-width="2"
            d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944
               a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9
               c0 5.591 3.824 10.29 9 11.622
               5.176-1.332 9-6.03 9-11.622
               0-1.042-.133-2.052-.382-3.016z" />
        </svg>
      </div>

      <h3 class="text-xl font-bold text-gray-800 mb-1">
        HR Monitor
      </h3>
      <p class="text-gray-600">
        ‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö HR Monitor
      </p>
    </div>

    <form onsubmit="verifyHRMonitorAccess(event)">
      <div class="mb-6">
        <label for="hrMonitorEmployeeId" class="block text-gray-700 font-semibold mb-2">
          ‡∏£‡∏´‡∏±‡∏™‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô
        </label>
        <input
          type="text"
          id="hrMonitorEmployeeId"
          required
          placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏´‡∏±‡∏™‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô"
          class="w-full px-4 py-3 rounded-xl border border-gray-300
                 focus:ring-2 focus:ring-blue-200 focus:border-blue-500
                 text-lg text-center"
        />
      </div>

      <!-- ‡∏õ‡∏∏‡πà‡∏°‡∏•‡πà‡∏≤‡∏á layout ‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ö HRBP: ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å + ‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö (‡πÄ‡∏ï‡πá‡∏°‡∏î‡πâ‡∏≤‡∏ô‡∏Ç‡∏ß‡∏≤) -->
      <div class="flex gap-3">
        <button
          type="button"
          onclick="closeHRMonitorLogin()"
          class="px-6 py-3 border border-gray-300 text-gray-700 font-semibold rounded-xl hover:bg-gray-50">
          ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å
        </button>
        <button
          type="submit"
          class="flex-1 px-6 py-3 bg-gradient-to-r from-blue-500 to-blue-600 text-white font-bold rounded-xl shadow-lg hover:shadow-xl">
          ‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö
        </button>
      </div>
    </form>
  </div>
</div>


  <!-- Case Detail Modal (demo) -->
  <div id="caseModal" class="hidden fixed inset-0 bg-black/50 flex items-center justify-center z-50">
    <div class="bg-white rounded-xl shadow-2xl p-8 max-w-4xl w-full mx-4 max-h-[90vh] overflow-y-auto">
      <div class="flex items-center justify-between mb-6">
        <h3 class="text-xl font-bold text-gray-800" id="caseTitle">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡πÄ‡∏Ñ‡∏™</h3>
        <button onclick="closeCaseModal()" class="text-gray-500 hover:text-gray-700" aria-label="‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡πà‡∏≤‡∏á">
          <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
        </button>
      </div>
      <div id="caseContent" class="space-y-4 mb-8"></div>
      <div class="flex gap-3">
        <button onclick="closeCaseModal()" class="flex-1 px-6 py-3 border border-gray-300 text-gray-700 font-semibold rounded-lg hover:bg-gray-50">‡∏õ‡∏¥‡∏î</button>
      </div>
    </div>
  </div>

  <script>
     // ===== API CONFIG & HELPERS =====
    // üîó ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÄ‡∏õ‡πá‡∏ô Web App URL ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì (‡∏Ç‡∏≠‡∏á Apps Script ‡∏ó‡∏µ‡πà‡∏°‡∏µ action=categories)
    const API_URL = 'https://script.google.com/macros/s/AKfycbyVTCcvjsZzYVWRXXd9ckqu20fGtZscPVFny0xv3J1wGFj8AzE9dk2N2Nw30o9mQVih/exec';

    async function apiGet(params) {
      const url = API_URL + '?' + new URLSearchParams(params).toString();
      const res = await fetch(url, { method:'GET' });
      if (!res.ok) throw new Error(`HTTP ${res.status}`);
      return res.json();
    }
    async function apiPost(payload) {
  // 1) ‡∏û‡∏¢‡∏≤‡∏¢‡∏≤‡∏°‡∏™‡πà‡∏á‡πÅ‡∏ö‡∏ö JSON (text/plain) ‡∏Å‡πà‡∏≠‡∏ô ‚Äì ‡πÑ‡∏°‡πà‡∏°‡∏µ header ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏•‡∏µ‡πà‡∏¢‡∏á preflight
  const controller = new AbortController();
  const t = setTimeout(() => controller.abort(), 30000); // 30s timeout (‡πÑ‡∏ü‡∏•‡πå‡πÉ‡∏´‡∏ç‡πà)
  try {
    const res = await fetch(API_URL, {
      method: 'POST',
      body: JSON.stringify(payload),
      signal: controller.signal,
      cache: 'no-cache',
      // no headers -> simple request
      // mode: 'cors' (‡∏Ñ‡πà‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß)
    });
    clearTimeout(t);
    if (!res.ok) throw new Error(`HTTP ${res.status}`);
    return await res.json();
  } catch (err) {
    clearTimeout(t);
    // 2) Fallback: ‡∏™‡πà‡∏á‡πÄ‡∏õ‡πá‡∏ô multipart/form-data (‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á CORS ‡πÄ‡∏ä‡πà‡∏ô‡∏Å‡∏±‡∏ô)
    //    ‡πÅ‡∏ô‡∏ö JSON ‡πÄ‡∏õ‡πá‡∏ô‡∏ü‡∏¥‡∏•‡∏î‡πå‡∏ä‡∏∑‡πà‡∏≠ "payload"
    const fd = new FormData();
    fd.append('payload', JSON.stringify(payload));

    // ‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏: ‡∏ñ‡πâ‡∏≤‡∏≠‡∏¢‡∏≤‡∏Å‡πÅ‡∏ô‡∏ö‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡πÄ‡∏î‡∏¥‡∏° (base64) ‡∏Å‡πá‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô payload ‡πÄ‡∏•‡∏¢
    const res2 = await fetch(API_URL, {
      method: 'POST',
      body: fd,
      cache: 'no-cache'
    });
    if (!res2.ok) throw new Error(`HTTP ${res2.status}`);
    // ‡∏ù‡∏±‡πà‡∏á Apps Script ‡∏à‡∏∞ parse e.parameter.payload ‡πÉ‡∏´‡πâ
    return await res2.json();
  }
}
    
     // üîπ ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÅ‡∏õ‡∏•‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà ISO ‚Üí ‡∏ß‡∏±‡∏ô/‡πÄ‡∏î‡∏∑‡∏≠‡∏ô/‡∏õ‡∏µ ‡πÄ‡∏ß‡∏•‡∏≤ (‡πÄ‡∏ß‡∏•‡∏≤‡πÑ‡∏ó‡∏¢)
    function formatDateTime(isoString) {
      if (!isoString) return '';
      const date = new Date(isoString);
      if (isNaN(date)) return isoString; // ‡∏Å‡∏±‡∏ô‡∏Å‡∏£‡∏ì‡∏µ‡πÅ‡∏õ‡∏•‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ

      const options = {
        timeZone: 'Asia/Bangkok',
        year: 'numeric',
        month: '2-digit',
        day: '2-digit',
        hour: '2-digit',
        minute: '2-digit'
      };

      const formatted = date.toLocaleString('th-TH', options);
      // "30/11/2025, 11:20" ‚Üí "30/11/2025 ‡πÄ‡∏ß‡∏•‡∏≤ 11:20"
      return formatted.replace(',', ' ‡πÄ‡∏ß‡∏•‡∏≤');
    }
    
// ===== Global state =====
let currentStep = 1;

let selectedCategory        = '';
let selectedCategoryTH      = '';
let selectedCategoryEN      = '';
let selectedSubCategory     = '';
let selectedSubCategoryName = '';
let selectedDetailName      = '';

let currentPage       = 'report';
let isHRBPLoggedIn    = false;
let isHistoryLoggedIn = false;
let isHRMonitorLoggedIn = false;

let currentHRBP = null;
let currentHRMonitor = null;

let historyEmp   = null;
let historyCases = [];

let hrbpCurrentRows   = [];
let hrbpFilterStatus  = 'ALL';
let hrbpPageSize      = 15;  // ‚úÖ ‡πÅ‡∏™‡∏î‡∏á 15 ‡πÄ‡∏Ñ‡∏™‡∏ï‡πà‡∏≠‡∏´‡∏ô‡πâ‡∏≤
let hrbpCurrentPage   = 1;   // ‚úÖ ‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô

let historyCurrentRows  = [];
let historyFilterStatus = 'ALL';

    // ===== Page router =====
    function showPage(page) {

  // ‡∏Å‡∏±‡∏ô‡πÄ‡∏õ‡∏¥‡∏î dashboard ‡∏ï‡∏£‡∏á ‡πÜ ‡∏ñ‡πâ‡∏≤‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà login HR Monitor
  if (page === 'dashboard' && !isHRMonitorLoggedIn) {
    openHRMonitorLogin();
    return;
  }

  currentPage = page;

  // --------- ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏Ñ‡πà‡∏≤‡∏Ç‡∏≠‡∏á‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏´‡∏ô‡πâ‡∏≤ ---------
  if (page === 'report') {
    if (typeof resetForm === 'function') {
      resetForm();
    }
  } else if (page === 'history') {
    if (typeof logoutHistory === 'function') {
      logoutHistory();
    }
  } else if (page === 'dashboard') {
    // ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ resetDashboard ‡πÉ‡∏ô‡∏≠‡∏ô‡∏≤‡∏Ñ‡∏ï ‡∏Ñ‡πà‡∏≠‡∏¢‡πÉ‡∏™‡πà
  } else if (page === 'hrbp') {
    // ‡∏´‡∏ô‡πâ‡∏≤ HRBP ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á reset ‡∏≠‡∏∞‡πÑ‡∏£‡∏û‡∏¥‡πÄ‡∏®‡∏©‡∏ï‡∏≠‡∏ô‡∏ô‡∏µ‡πâ
  }

  // --------- ‡∏ã‡πà‡∏≠‡∏ô‡∏ó‡∏∏‡∏Å‡∏´‡∏ô‡πâ‡∏≤ ---------
  document.getElementById('reportPage').classList.add('hidden');
  document.getElementById('historyPage').classList.add('hidden');
  document.getElementById('dashboardPage').classList.add('hidden');
  document.getElementById('hrbpPage').classList.add('hidden');

  // --------- ‡πÅ‡∏™‡∏î‡∏á‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢ ---------
  if (page === 'report') {
    document.getElementById('reportPage').classList.remove('hidden');
  } else if (page === 'history') {
    document.getElementById('historyPage').classList.remove('hidden');
  } else if (page === 'dashboard') {
    document.getElementById('dashboardPage').classList.remove('hidden');
  } else if (page === 'hrbp') {
    document.getElementById('hrbpPage').classList.remove('hidden');
  }

  // --------- ‡∏õ‡∏¥‡∏î‡πÄ‡∏°‡∏ô‡∏π‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡∏¥‡∏î‡∏≠‡∏¢‡∏π‡πà ---------
  const mm = document.getElementById('mobileMenu');
  if (mm && !mm.classList.contains('hidden')) {
    mm.classList.add('hidden');
  }
}

    // === CACHE CONFIG ===
  const CATEGORY_CACHE_KEY = 'hrir_categories_v1';
  const CATEGORY_TTL_MS = 5 * 60 * 1000; // 5 ‡∏ô‡∏≤‡∏ó‡∏µ
  let categoryMemCache = null;

  function getCachedCategories() {
    if (categoryMemCache) return categoryMemCache;
    try {
      const raw = localStorage.getItem(CATEGORY_CACHE_KEY);
      if (!raw) return null;
      const { ts, rows } = JSON.parse(raw);
      if (!ts || !rows) return null;
      if (Date.now() - ts > CATEGORY_TTL_MS) return null;
      categoryMemCache = rows;
      return rows;
    } catch { return null; }
  }
  function setCachedCategories(rows) {
    categoryMemCache = rows;
    try { localStorage.setItem(CATEGORY_CACHE_KEY, JSON.stringify({ ts: Date.now(), rows })); } catch {}
  }

  function renderCategorySkeleton() {
    const grid = document.getElementById('categoryGrid');
    grid.innerHTML = '';
    const frag = document.createDocumentFragment();
    for (let i = 0; i < 8; i++) {
      const s = document.createElement('div');
      s.className = 'rounded-xl shadow-lg px-6 py-6 border border-gray-100 skeleton';
      s.style.height = '92px';
      frag.appendChild(s);
    }
    grid.appendChild(frag);
  }

  function renderCategories(rows) {
    const grid = document.getElementById('categoryGrid');
    grid.innerHTML = '';
    const palette = ['blue','orange','yellow','purple','pink','green','indigo'];
    const frag = document.createDocumentFragment();
    rows.forEach((cat, i) => {
      const tone = palette[i % palette.length];
      const btn = document.createElement('button');
      btn.className = `card-hover bg-gradient-to-br from-white to-${tone}-50
  rounded-xl shadow-lg px-6 py-6 border border-${tone}-100
  hover:border-${tone}-300 hover:shadow-xl text-left
  transition-all duration-200 h-[130px] flex flex-col justify-center`;
      btn.innerHTML = `
        <div class="text-center">
          <h3 class="text-base font-bold text-gray-800 mb-1">${escapeHTML_(cat.th)}</h3>
          <p class="text-xs text-gray-600">${escapeHTML_(cat.en || '')}</p>
        </div>`;
      btn.onclick = () => selectCategory(cat);
      frag.appendChild(btn);
    });
    grid.appendChild(frag);
  }
    
    // ===== Dynamic Categories from Case_Master M/N =====
    async function loadCategories(opts = {}){
  const silent = !!opts.silent;
  const grid = document.getElementById('categoryGrid');
  const errorBox = document.getElementById('categoryError');

  if(!silent){
    // ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏° loader ‡πÅ‡∏•‡πâ‡∏ß: ‡∏ã‡πà‡∏≠‡∏ô error ‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÄ‡∏î‡∏µ‡∏¢‡∏ß
    errorBox.classList.add('hidden');
    // ‡∏ñ‡πâ‡∏≤‡∏≠‡∏¢‡∏≤‡∏Å‡∏°‡∏µ skeleton ‡∏ï‡∏≠‡∏ô‡πÑ‡∏°‡πà silent ‡∏Ñ‡∏á‡πÑ‡∏ß‡πâ‡πÑ‡∏î‡πâ:
    renderCategorySkeleton();
  }

  const cached = getCachedCategories();
  if (cached && cached.length) {
    renderCategories(cached);
    // ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏≠‡∏∞‡πÑ‡∏£‡∏ï‡πâ‡∏≠‡∏á‡∏ã‡πà‡∏≠‡∏ô ‡πÄ‡∏û‡∏£‡∏≤‡∏∞‡πÄ‡∏£‡∏≤‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πâ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏° loader ‡πÅ‡∏•‡πâ‡∏ß
    if (silent) {
      // silent mode ‡∏Å‡πá‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏ó‡∏≥‡∏≠‡∏∞‡πÑ‡∏£‡πÄ‡∏û‡∏¥‡πà‡∏°
    }
  }

  const controller = new AbortController();
  const timeoutId = setTimeout(() => controller.abort(), 5000);

  try{
    const url = API_URL + '?' + new URLSearchParams({ action:'categories' }).toString();
    const res = await fetch(url, { method:'GET', signal: controller.signal, cache:'no-cache' });
    clearTimeout(timeoutId);
    if(!res.ok) throw new Error(`HTTP ${res.status}`);
    const rs = await res.json();
    if(!rs.ok) throw new Error(rs.error || '‡πÇ‡∏´‡∏•‡∏î‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');

    const rows = rs.rows || [];
    if(!rows.length) throw new Error('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà‡πÉ‡∏ô Case_Master (‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå M/N)');

    renderCategories(rows);
    setCachedCategories(rows);
  }catch(err){
    clearTimeout(timeoutId);
    if(!silent){
      errorBox.textContent = (err.name==='AbortError') ? '‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏ä‡πâ‡∏≤ ‡πÇ‡∏õ‡∏£‡∏î‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà' : String(err.message || err);
      errorBox.classList.remove('hidden');
    }
  }
}

    function escapeHTML_(s){
      return String(s || '')
        .replace(/&/g,'&amp;').replace(/</g,'&lt;')
        .replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&#39;');
    }
    
    function showLoading(text='‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...'){
  const m = document.getElementById('loadingModal');
  const t = document.getElementById('loadingText');
  if(t) t.textContent = text;
  m.classList.remove('hidden');
}
function hideLoading(){
  document.getElementById('loadingModal').classList.add('hidden');
}
  async function loadSubCategories(catTH, opts = {}) {
  const silent = !!opts.silent;
  const container = document.getElementById('subCategoryCards');
  container.innerHTML = ''; // ‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå‡πÄ‡∏î‡∏¥‡∏°‡∏Å‡πà‡∏≠‡∏ô

  const controller = new AbortController();
  const timeoutId = setTimeout(() => controller.abort(), 5000);

  try{
    // ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å action=subcategories ‡πÇ‡∏î‡∏¢‡∏™‡πà‡∏á cat=‡∏ä‡∏∑‡πà‡∏≠‡∏´‡∏°‡∏ß‡∏î‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢
    const url = API_URL + '?' + new URLSearchParams({ action:'subcategories', cat:catTH }).toString();
    const res = await fetch(url, { method:'GET', signal: controller.signal, cache:'no-cache' });
    clearTimeout(timeoutId);
    if(!res.ok) throw new Error(`HTTP ${res.status}`);
    const rs = await res.json();
    if(!rs.ok) throw new Error(rs.error || '‡πÇ‡∏´‡∏•‡∏î‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏¢‡πà‡∏≠‡∏¢‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');

    const rows = rs.rows || [];
    renderSubCategoryCards(rows);

    return rows;
  }catch(err){
    clearTimeout(timeoutId);
    // ‡πÅ‡∏™‡∏î‡∏á error ‡∏™‡∏±‡πâ‡∏ô ‡πÜ ‡∏ó‡∏µ‡πà Step 3 ‡∏ñ‡πâ‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£
    const scTitle = document.getElementById('subCategoryTitle');
    scTitle.textContent = '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏¢‡πà‡∏≠‡∏¢';
    document.getElementById('subCategoryCards').innerHTML =
      `<div class="text-center text-sm text-red-600"> ${String(err.message || err)} </div>`;
    return [];
  }
}
    
   async function loadDetails(catTH, subTH){
  const controller = new AbortController();
  const timeoutId = setTimeout(() => controller.abort(), 5000);
  try{
    const url = API_URL + '?' + new URLSearchParams({
      action:'details',
      cat: catTH,
      sub: subTH
    }).toString();
    const res = await fetch(url, { method:'GET', signal: controller.signal, cache:'no-cache' });
    clearTimeout(timeoutId);
    if(!res.ok) throw new Error(`HTTP ${res.status}`);
    const rs = await res.json();
    if(!rs.ok) throw new Error(rs.error || '‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
    return rs.rows || {detail1:[],detail2:[],detail3:[],detail4:[],detail5:[]};
  }catch(err){
    clearTimeout(timeoutId);
    console.error(err);
    return {detail1:[],detail2:[],detail3:[],detail4:[],detail5:[]};
  }
}

function renderDetailCards(groups){
  const container = document.getElementById('subCategoryCards');
  container.innerHTML = '';

  // ‡∏£‡∏ß‡∏°‡∏ó‡∏∏‡∏Å detail ‡πÄ‡∏Ç‡πâ‡∏≤‡∏î‡πâ‡∏ß‡∏¢‡∏Å‡∏±‡∏ô
  const all = [
    ...groups.detail1,
    ...groups.detail2,
    ...groups.detail3,
    ...groups.detail4,
    ...groups.detail5
  ].filter(Boolean);

  // ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏•‡∏¢ ‚Üí ‡πÑ‡∏õ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏ï‡∏±‡∏ß‡∏ï‡∏ô
  if (all.length === 0){
    showEmployeeLogin();
    return;
  }

  // ‡∏ï‡∏±‡πâ‡∏á‡∏ä‡∏∑‡πà‡∏≠‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡∏î‡πâ‡∏≤‡∏ô‡∏ö‡∏ô
  document.getElementById('subCategoryTitle').textContent = 
    `‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏Ç‡∏≠‡∏á ‚Äú${selectedSubCategoryName}‚Äù`;

  // ‡πÉ‡∏ä‡πâ‡∏™‡∏µ‡∏Ñ‡∏•‡∏∞‡πÅ‡∏ö‡∏ö‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏£‡∏Å
  const palette = ['blue','orange','yellow','purple','pink','green','indigo'];
  const frag = document.createDocumentFragment();

  all.forEach((name, i) => {
    const tone = palette[i % palette.length];
    const btn = document.createElement('button');
    btn.type = 'button';
    btn.className = `
      card-hover bg-gradient-to-br from-white to-${tone}-50
      rounded-2xl shadow-xl p-6 border border-${tone}-100
      hover:border-${tone}-300 hover:shadow-2xl
      h-[130px] w-full flex items-center justify-center text-center
      transition
    `;
    btn.innerHTML = `<div><h4 class="text-base font-semibold text-gray-800">${escapeHTML_(name)}</h4></div>`;
    btn.onclick = () => selectDetail(name);
    frag.appendChild(btn);
  });

  container.appendChild(frag);
}

function renderSubCategoryCards(rows){
  const container = document.getElementById('subCategoryCards');
  container.innerHTML = '';

  if (!rows.length) {
    container.innerHTML = `<div class="text-center text-gray-600 text-sm">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏¢‡πà‡∏≠‡∏¢‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏´‡∏°‡∏ß‡∏î‡∏ô‡∏µ‡πâ</div>`;
    return;
  }

  // ‡πÇ‡∏ó‡∏ô‡∏™‡∏µ‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏£‡∏Å (‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏•‡∏±‡∏Å)
  const palette = ['blue','orange','yellow','purple','pink','green','indigo'];

  const frag = document.createDocumentFragment();
  rows.forEach((r, i) => {
    const tone = palette[i % palette.length];

    const card = document.createElement('button');
    card.type = 'button';
    card.className =
      `card-hover bg-gradient-to-br from-white to-${tone}-50
       rounded-2xl shadow-xl p-6 border border-${tone}-100
       hover:border-${tone}-300 hover:shadow-2xl
       h-[130px] w-full flex items-center justify-center text-center transition`;

    // ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏≠‡∏¥‡πÇ‡∏°‡∏à‡∏¥‡πÅ‡∏•‡πâ‡∏ß‡∏ô‡∏∞‡∏Ñ‡∏£‡∏±‡∏ö
    card.innerHTML = `
      <div>
        <h3 class="text-base font-semibold text-gray-800 mb-1">${escapeHTML_(r.name)}</h3>
      </div>
    `;

    card.onclick = () => selectSubCategory(r.name);
    frag.appendChild(card);
  });

  container.appendChild(frag);
}
   
    // ===== Employee login (for proceeding to details) =====
    function showEmployeeLogin(){ document.getElementById('employeeModal').classList.remove('hidden'); }
    function closeEmployeeModal(){ document.getElementById('employeeModal').classList.add('hidden'); }
    // helper ‡∏Å‡∏±‡∏ô‡∏û‡∏±‡∏á‡∏ñ‡πâ‡∏≤ id ‡πÑ‡∏´‡∏ô‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏ß‡∏≤‡∏á‡πÉ‡∏ô DOM
function setVal(id, v){
  const el = document.getElementById(id);
  if (el) el.value = v || '';
  else console.warn('Missing element id:', id);
}

async function verifyEmployee(e){
  e.preventDefault();
  const id = document.getElementById('employeeId').value.trim();
  if(!id) return alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏´‡∏±‡∏™‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô');

  showLoading('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏£‡∏´‡∏±‡∏™‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô...');
  try {
    const res = await fetch(API_URL + '?action=employee&empId=' + encodeURIComponent(id));
    const rs = await res.json();
    hideLoading();

    if (!rs.ok) {
      alert('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô: ' + (rs.error || ''));
      return;
    }

    const emp = rs.data || {};

    // ‡∏Ñ‡∏π‡πà‡∏ó‡∏µ‡πà‡∏Ñ‡∏∏‡∏ì‡∏Å‡∏≥‡∏´‡∏ô‡∏î:
    // ‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏• - ‡∏£‡∏´‡∏±‡∏™‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô
    setVal('employeeName', emp.name);
    setVal('employeeCode', emp.empId);

    // Company - Division
    setVal('employeeCompany',  emp.company);
    setVal('employeeDivision', emp.division);

    // Department - Store
    setVal('employeeDepartment', emp.department);
    setVal('employeeStore',      emp.store);

    // Email - Contact number
    setVal('employeeEmail', emp.email);
    setVal('employeePhone', emp.phone);

    // HRBP
    setVal('assignedHRBP',      emp.hrbp);
    setVal('assignedHRBPEmail', emp.hrbpEmail);

    closeEmployeeModal();
    proceedToDetails();
  } catch(err){
  hideLoading();
  const msg = (err && err.message) ? err.message : String(err);
  alert('‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à\n' + msg + '\n\n(‡∏ñ‡πâ‡∏≤‡∏Ç‡∏∂‡πâ‡∏ô AbortError ‡πÉ‡∏´‡πâ‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà/‡πÄ‡∏ô‡πá‡∏ï‡∏ä‡πâ‡∏≤)');
}
  } 

    // ===== Category & Sub-category =====
       async function selectCategory(cat){
  // ‡πÄ‡∏Å‡πá‡∏ö‡∏Ñ‡πà‡∏≤‡∏´‡∏°‡∏ß‡∏î‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å (‡∏à‡∏≤‡∏Å action=categories)
  selectedCategory   = String(cat.slug || '').trim();
  selectedCategoryTH = String(cat.th   || '').trim();
  selectedCategoryEN = String(cat.en   || '').trim();

  // ‡πÄ‡∏õ‡∏¥‡∏î popup ‡πÇ‡∏´‡∏•‡∏î
  showLoading('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏¢‡πà‡∏≠‡∏¢...');
         
         // ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å API ‡∏´‡∏≤ "‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏¢‡πà‡∏≠‡∏¢" ‡∏Ç‡∏≠‡∏á‡∏´‡∏°‡∏ß‡∏î‡∏ô‡∏µ‡πâ (‡∏Å‡∏£‡∏≠‡∏á‡∏ï‡∏≤‡∏°‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå A)
  const subs = await loadSubCategories(selectedCategoryTH, { silent:true });
         
         // ‡∏õ‡∏¥‡∏î popup
  hideLoading();

      // ‡∏ñ‡πâ‡∏≤ slug ‡πÄ‡∏Ç‡πâ‡∏≤‡∏Å‡∏±‡∏ö‡πÅ‡∏°‡∏õ‡πÄ‡∏î‡∏¥‡∏° (termination/accident/safety/complaint) ‚Üí ‡πÅ‡∏™‡∏î‡∏á sub
     if (subs && subs.length){
    // ‡∏°‡∏µ‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏¢‡πà‡∏≠‡∏¢ ‚Üí ‡πÑ‡∏õ Step 3
    document.getElementById('subCategoryTitle').textContent = `‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏¢‡πà‡∏≠‡∏¢‡∏Ç‡∏≠‡∏á ‚Äú${selectedCategoryTH || '‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà'}‚Äù`;
    document.getElementById('categoryStep').classList.add('hidden');
    document.getElementById('subCategoryStep').classList.remove('hidden');
    document.getElementById('step2').classList.remove('active');
    document.getElementById('step2').classList.add('completed');
    document.getElementById('step3').classList.add('active');
    currentStep = 3;
  } else {
    // ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏¢‡πà‡∏≠‡∏¢ ‚Üí ‡∏Ç‡πâ‡∏≤‡∏°‡πÑ‡∏õ‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î
    selectedSubCategoryName = '';
    showEmployeeLogin();
      }
    }

    function showSubCategories(category){
      const container = document.getElementById('subCategoryCards');
      container.innerHTML = '';
      (subCategories[category]||[]).forEach(sub => {
        const card = document.createElement('button');
        card.type = 'button';
        card.className = 'card-hover bg-gradient-to-br from-white to-blue-50 rounded-2xl shadow-xl p-6 border border-blue-100 hover:border-blue-300 hover:shadow-2xl';
        card.innerHTML = `<div class="text-center"><div class="text-4xl mb-4">${sub.icon}</div><h3 class="text-lg font-bold text-gray-800 mb-2">${sub.name}</h3><p class="text-sm text-gray-600">${sub.desc}</p></div>`;
        card.onclick = () => selectSubCategory(sub.id);
        container.appendChild(card);
      });
    }
    async function selectSubCategory(name){
  selectedSubCategoryName = name;

  // ‡πÄ‡∏õ‡∏¥‡∏î popup ‡πÇ‡∏´‡∏•‡∏î
  showLoading('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î...');
  const groups = await loadDetails(selectedCategoryTH, selectedSubCategoryName);
  hideLoading();

  // ‡πÅ‡∏™‡∏î‡∏á‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏†‡∏≤‡∏¢‡πÉ‡∏ô Step 3 ‡πÄ‡∏î‡∏¥‡∏° (‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏Å‡∏≤‡∏£‡πå‡∏î‡πÉ‡∏ô subCategoryCards)
  renderDetailCards(groups);
}
    
    function selectDetail(name){
  selectedDetailName = name;
  showEmployeeLogin();
}

    // ===== Details step =====
   function proceedToDetails() {
  const catLabel = selectedCategoryTH || '‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà';
  const subLabel = selectedSubCategoryName || '';
  const detLabel = selectedDetailName || '';

  // ‚úÖ ‡∏ï‡∏±‡πâ‡∏á‡∏£‡∏π‡∏õ‡πÑ‡∏≠‡∏Ñ‡∏≠‡∏ô (‡πÉ‡∏ä‡πâ clipboard.png ‡∏ï‡∏•‡∏≠‡∏î)
  const iconEl = document.getElementById('priorityIcon');
  if (iconEl) {
    iconEl.src = './clipboard.png'; // ‡∏ä‡∏∑‡πà‡∏≠‡πÑ‡∏ü‡∏•‡πå‡∏ï‡∏≤‡∏°‡∏ó‡∏µ‡πà‡∏≠‡∏±‡∏û‡πÑ‡∏ß‡πâ (‡∏ï‡∏±‡∏ß‡∏û‡∏¥‡∏°‡∏û‡πå‡πÄ‡∏•‡πá‡∏Å-‡πÉ‡∏´‡∏ç‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏ï‡∏£‡∏á)
    iconEl.className = 'w-12 h-12 mr-3 object-contain';
  } 

  // ‡∏ï‡∏±‡πâ‡∏á‡∏´‡∏±‡∏ß‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á
  let title = `‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î${catLabel}`;
  if (subLabel) title += ` - ${subLabel}`;
  if (detLabel) title += ` - ${detLabel}`;
  document.getElementById('formTitle').textContent = title;
  document.getElementById('formSubtitle').textContent =
    detLabel ? `‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Å‡∏±‡∏ö ${detLabel} ‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô`
             : (subLabel ? `‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Å‡∏±‡∏ö ${subLabel} ‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô`
                         : `‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Å‡∏±‡∏ö ${catLabel} ‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô`);

  // ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô
  const now = new Date();
  document.getElementById('reportDate').value =
    new Intl.DateTimeFormat('en-CA', { timeZone:'Asia/Bangkok' }).format(now);
  document.getElementById('reportTime').value =
    new Intl.DateTimeFormat('en-GB', { hour: '2-digit', minute: '2-digit', hour12:false, timeZone:'Asia/Bangkok' }).format(now);

  // ‡πÇ‡∏ä‡∏ß‡πå Step 4
  document.getElementById('subCategoryStep').classList.add('hidden');
  document.getElementById('categoryStep').classList.add('hidden');
  document.getElementById('detailsStep').classList.remove('hidden');

  document.getElementById('step2').classList.remove('active');
  document.getElementById('step2').classList.add('completed');
  document.getElementById('step3').classList.add('completed');
  document.getElementById('step4').classList.add('active');
  currentStep = 4;

      // ‡πÉ‡∏´‡πâ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡πÄ‡∏õ‡πá‡∏ô‡πÇ‡∏´‡∏°‡∏î‡∏≠‡πà‡∏≤‡∏ô‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡πÅ‡∏•‡∏∞‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡∏≤‡πÄ‡∏ó‡πà‡∏≤‡∏Å‡∏±‡∏ö‡∏ä‡πà‡∏≠‡∏á‡∏ú‡∏π‡πâ‡πÅ‡∏à‡πâ‡∏á
  setReadonlyStyle(document.getElementById('reportDate'), true);
  setReadonlyStyle(document.getElementById('reportTime'), true);
}

    function goBackToCategory(){
      document.getElementById('subCategoryStep').classList.add('hidden');
      document.getElementById('categoryStep').classList.remove('hidden');
      document.getElementById('step3').classList.add('active');
    }

   function setReadonlyStyle(input, isReadonly){
  if (isReadonly){
    input.readOnly = true;
    input.classList.remove('cursor-not-allowed','bg-gray-100','border-gray-300');
    input.classList.add('bg-blue-50','border','border-blue-300');
  } else {
    input.readOnly = false;
    input.classList.remove('bg-gray-100','border-gray-300','cursor-not-allowed');
    input.classList.add(
      'bg-blue-50','border','border-blue-300',
      'focus:ring-2','focus:ring-blue-400','focus:border-blue-400'
    );
    input.focus();
  }
}

function toggleDateEdit(){
  const el  = document.getElementById('reportDate');
  const btn = document.getElementById('editDateBtn');
  setReadonlyStyle(el, !el.readOnly);      // ‡∏ñ‡πâ‡∏≤‡πÄ‡∏î‡∏¥‡∏°‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç ‚Üí ‡∏Å‡∏•‡∏±‡∏ö‡πÄ‡∏õ‡πá‡∏ô‡∏≠‡πà‡∏≤‡∏ô‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÄ‡∏î‡∏µ‡∏¢‡∏ß
  btn.textContent = el.readOnly ? '‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç' : '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å';
}

function toggleTimeEdit(){
  const el  = document.getElementById('reportTime');
  const btn = document.getElementById('editTimeBtn');
  setReadonlyStyle(el, !el.readOnly);
  btn.textContent = el.readOnly ? '‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç' : '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å';
}

    async function nextStep(){
  const ids = ['introStep','categoryStep','subCategoryStep','detailsStep','successStep'];

  // ‡∏ã‡πà‡∏≠‡∏ô section ‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô + ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏ï‡∏±‡∏ß‡∏ä‡∏µ‡πâ‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô
  document.getElementById(ids[currentStep-1]).classList.add('hidden');
  if(currentStep <= 4){
    const step = document.getElementById(`step${currentStep}`);
    step.classList.remove('active');
    step.classList.add('completed');
  }
  currentStep++;

  // ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡∏™tep 2 ‡∏Å‡πá‡πÅ‡∏™‡∏î‡∏á‡∏ï‡∏≤‡∏°‡∏õ‡∏Å‡∏ï‡∏¥
  if (currentStep !== 2){
    document.getElementById(ids[currentStep-1]).classList.remove('hidden');
    if(currentStep <= 4){ document.getElementById(`step${currentStep}`).classList.add('active'); }
    return;
  }

  // === ‡πÄ‡∏Ç‡πâ‡∏≤‡∏™tep 2: ‡πÇ‡∏´‡∏•‡∏î‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà‡πÅ‡∏ö‡∏ö‡∏°‡∏µ popup ===
  document.getElementById(`step${currentStep}`).classList.add('active');

  // ‡∏¢‡∏±‡∏á "‡πÑ‡∏°‡πà" ‡πÄ‡∏õ‡∏¥‡∏î categoryStep ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÑ‡∏°‡πà‡πÉ‡∏´‡πâ‡∏û‡∏∑‡πâ‡∏ô‡∏´‡∏•‡∏±‡∏á‡πÇ‡∏ä‡∏ß‡πå‡∏Å‡πà‡∏≠‡∏ô
  document.getElementById('categoryStep').classList.add('hidden');

  // ‡πÄ‡∏õ‡∏¥‡∏î popup ‡πÇ‡∏´‡∏•‡∏î
  showLoading('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á...');

  // ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• + render ‡∏Å‡∏≤‡∏£‡πå‡∏î (‡πÅ‡∏ö‡∏ö‡πÄ‡∏á‡∏µ‡∏¢‡∏ö ‡πÑ‡∏°‡πà‡πÅ‡∏ï‡∏∞ loader ‡∏ö‡∏ô‡∏´‡∏ô‡πâ‡∏≤)
  await loadCategories({ silent:true });

  // ‡∏õ‡∏¥‡∏î popup ‡πÅ‡∏•‡πâ‡∏ß‡πÇ‡∏ä‡∏ß‡πå section ‡∏û‡∏£‡πâ‡∏≠‡∏° effect ‡πÄ‡∏ú‡∏¢‡∏ó‡∏±‡πâ‡∏á‡∏ä‡∏∏‡∏î
  hideLoading();
  const section = document.getElementById('categoryStep');
  section.classList.remove('hidden');
  section.classList.add('opacity-0');
  requestAnimationFrame(()=>{
    section.classList.add('transition-opacity','duration-300');
    section.classList.remove('opacity-0');
  });
}

    function goBack(){
      if(currentStep === 4){
        document.getElementById('detailsStep').classList.add('hidden');
        document.getElementById('subCategoryStep').classList.remove('hidden');
        document.getElementById('step4').classList.remove('active');
        document.getElementById('step3').classList.remove('completed');
        document.getElementById('step3').classList.add('active');
        currentStep = 3;
        return;
      }
      const ids = ['introStep','categoryStep','subCategoryStep','detailsStep','successStep'];
      document.getElementById(ids[currentStep-1]).classList.add('hidden');
      if(currentStep <= 4){ document.getElementById(`step${currentStep}`).classList.remove('active'); }
      currentStep--;
      if(currentStep <= 4){
        const step = document.getElementById(`step${currentStep}`);
        step.classList.remove('completed');
        step.classList.add('active');
      } 
      document.getElementById(ids[currentStep-1]).classList.remove('hidden');
    }

    function markAllStepsCompleted() {
  for (let i = 1; i <= 4; i++) {
    const el = document.getElementById('step' + i);
    if (!el) continue;
    el.classList.remove('active');
    el.classList.add('completed');
  }
}   
    
   async function submitReport(e){
  e.preventDefault();

  // ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô
  const detailText = (document.getElementById('incidentDetail').value || '').trim();
  if(!detailText){
    alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡πÄ‡∏´‡∏ï‡∏∏‡∏Å‡∏≤‡∏£‡∏ì‡πå');
    return;
  }

     // ‡πÉ‡∏ä‡πâ detailText ‡πÄ‡∏õ‡πá‡∏ô Comment ‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡πá‡∏ö‡πÉ‡∏ô‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå F
const Comment = detailText;

  // ‚úÖ ‡∏î‡∏∂‡∏á‡∏Ñ‡πà‡∏≤ Format + Location
  const LocationFormat = (document.getElementById('locationFormat').value || '').trim();
  const LocationOnly   = (document.getElementById('locationInput').value || '').trim();

  const Format   = LocationFormat;
  const Location = LocationOnly;

  // ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡πÅ‡∏à‡πâ‡∏á
  const EmpName  = (document.getElementById('employeeName').value || '').trim();
  const EmpId    = (document.getElementById('employeeCode').value || '').trim();
  const Dept     = (document.getElementById('employeeDepartment').value || '').trim();
  const Phone    = (document.getElementById('employeePhone').value || '').trim();

  if(!EmpId){
    alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏ï‡∏±‡∏ß‡∏ï‡∏ô‡∏ú‡∏π‡πâ‡πÅ‡∏à‡πâ‡∏á‡∏Å‡πà‡∏≠‡∏ô (‡∏Å‡∏£‡∏≠‡∏Å ‚Äú‡∏£‡∏´‡∏±‡∏™‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‚Äù)');
    return;
  }

  // ‡∏à‡∏≤‡∏Å Step ‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å
  const Category    = selectedCategoryTH || '';
  const SubCategory = selectedSubCategoryName || '';
  const Detail      = selectedDetailName || '';

  // ‡∏ï‡∏£‡∏ß‡∏à‡∏Ç‡∏ô‡∏≤‡∏î‡πÑ‡∏ü‡∏•‡πå‡∏£‡∏ß‡∏°
  const total = Array.from(document.getElementById('incidentPhotos').files || [])
    .reduce((s,f)=> s + f.size, 0);
  if (total > MAX_TOTAL_UPLOAD) {
    alert('‡∏Ç‡∏ô‡∏≤‡∏î‡πÑ‡∏ü‡∏•‡πå‡∏£‡∏ß‡∏°‡πÄ‡∏Å‡∏¥‡∏ô 20MB ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏î‡∏à‡∏≥‡∏ô‡∏ß‡∏ô/‡∏Ç‡∏ô‡∏≤‡∏î‡πÑ‡∏ü‡∏•‡πå');
    return;
  }

  try{
    showLoading('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå‡πÅ‡∏•‡∏∞‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÄ‡∏Ñ‡∏™...');
    const Images = await collectImagesFromInput();

    const payload = {
      action: 'create',
      Category, 
      SubCategory, 
      Detail, 
      Comment,
      Format,
      Location,
      EmpId, 
      EmpName, 
      Dept, 
      Phone,
      Images
    };

    const rs = await apiPost(payload);
    hideLoading();

    if(!rs.ok){
      alert('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ' + (rs.error || 'unknown'));
      return;
    }

    document.getElementById('referenceNumber').textContent = rs.caseId || '‚Äî';
    markAllStepsCompleted();
    nextStep();
  }catch(err){
    hideLoading();
    alert('‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à\n' + (err.message || err));
  }
}

   function resetForm(){
  // ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£ step / category
  currentStep = 1;
  selectedCategory = '';
  selectedCategoryTH = '';
  selectedCategoryEN = '';
  selectedSubCategory = '';
  selectedSubCategoryName = '';
  selectedDetailName = '';

  // ‡πÅ‡∏™‡∏î‡∏á‡∏´‡∏ô‡πâ‡∏≤ Step 1 ‡πÉ‡∏´‡∏°‡πà ‡πÅ‡∏•‡∏∞‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ step ‡∏ö‡∏ô progress bar
  const ids = ['introStep','categoryStep','subCategoryStep','detailsStep','successStep'];
  ids.forEach((id, i)=>{
    const el = document.getElementById(id);
    if (i === 0) el.classList.remove('hidden');
    else el.classList.add('hidden');

    if (i < 4){
      const st = document.getElementById(`step${i+1}`);
      st.classList.remove('active','completed');
    }
  });
  document.getElementById('step1').classList.add('active');

  // ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏Ñ‡πà‡∏≤‡∏ó‡∏∏‡∏Å form element
  document.querySelectorAll('form').forEach(f => f.reset());

  // üîπ ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤‡πÑ‡∏ü‡∏•‡πå‡∏£‡∏π‡∏õ + preview ‡∏£‡∏π‡∏õ
  try {
    if (typeof uploadDT !== 'undefined') {
      // ‡∏•‡πâ‡∏≤‡∏á DataTransfer (‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤‡πÑ‡∏ü‡∏•‡πå)
      uploadDT = new DataTransfer();
    }
    if (typeof fileInput !== 'undefined' && fileInput) {
      // ‡∏•‡πâ‡∏≤‡∏á‡∏Ñ‡πà‡∏≤‡∏ó‡∏µ‡πà input file ‡πÅ‡∏•‡∏∞‡∏ú‡∏π‡∏Å‡∏Å‡∏•‡∏±‡∏ö‡∏Å‡∏±‡∏ö‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤‡πÉ‡∏´‡∏°‡πà (‡∏ß‡πà‡∏≤‡∏á)
      fileInput.value = '';
      if (typeof uploadDT !== 'undefined') {
        fileInput.files = uploadDT.files;
      }
    }
    if (typeof previewEl !== 'undefined' && previewEl) {
      // ‡∏•‡πâ‡∏≤‡∏á‡∏£‡∏π‡∏õ‡∏ó‡∏µ‡πà‡πÅ‡∏™‡∏î‡∏á‡∏ö‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠
      previewEl.innerHTML = '';
    }
  } catch (e) {
    console.error('reset images error', e);
  }
}

    // ===== HRBP login & dashboard =====
function showHRBPLogin() {
  // ‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå‡∏Ñ‡πà‡∏≤‡∏ó‡∏µ‡πà‡∏Å‡∏£‡∏≠‡∏Å HRBP ID ‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏Å‡πà‡∏≠‡∏ô‡πÅ‡∏™‡∏î‡∏á Modal
  const input = document.getElementById('hrbpId');
  if (input) {
    input.value = '';
  }

  // ‡πÅ‡∏™‡∏î‡∏á‡∏Å‡∏•‡πà‡∏≠‡∏á Login HRBP
  document.getElementById('hrbpModal').classList.remove('hidden');
}

function closeHRBPModal() {
  document.getElementById('hrbpModal').classList.add('hidden');
}

/** ‚úÖ ‡∏ï‡∏£‡∏ß‡∏à‡∏£‡∏´‡∏±‡∏™ HRBP ‡∏à‡∏≤‡∏Å‡∏ä‡∏µ‡∏ï HRBP ‡∏ú‡πà‡∏≤‡∏ô Apps Script (action=hrbp-login) */
async function verifyHRBP(e) {
  e.preventDefault();

  const input = document.getElementById('hrbpId');
  const id    = input.value.trim();   // ‡πÉ‡∏ä‡πâ EMP ID ‡∏à‡∏£‡∏¥‡∏á‡∏ï‡∏≤‡∏°‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå A

  if (!id) {
    alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏´‡∏±‡∏™‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô HRBP');
    return;
  }

  try {
    showLoading('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏£‡∏´‡∏±‡∏™ HRBP...');

    // ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å Apps Script: ‡πÑ‡∏õ‡∏ó‡∏µ‡πà handleHRBPLogin_(e)
    const rs = await apiGet({ action: 'hrbp-login', hrbpId: id });

    hideLoading();

    if (!rs.ok || !rs.data) {
      alert(rs.error || '‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏£‡∏´‡∏±‡∏™ HRBP ‡∏ô‡∏µ‡πâ‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö');
      return;
    }

    // ‡πÄ‡∏Å‡πá‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• HRBP ‡∏ó‡∏µ‡πà‡∏•‡πá‡∏≠‡∏Å‡∏≠‡∏¥‡∏ô { id, name, email }
    currentHRBP     = rs.data;
    isHRBPLoggedIn  = true;

    // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÉ‡∏ô‡∏´‡∏ô‡πâ‡∏≤ HRBP
    const nameEl = document.getElementById('hrbpHeaderName');
    const mailEl = document.getElementById('hrbpHeaderEmail');
    if (nameEl) nameEl.textContent = currentHRBP.name || currentHRBP.id;
    if (mailEl) mailEl.textContent = currentHRBP.email || '';

    closeHRBPModal();

    // ‡πÄ‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤ HRBP
    showPage('hrbp');

    // ‡∏î‡∏∂‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏Ñ‡∏™‡∏ó‡∏µ‡πà HRBP ‡∏ô‡∏µ‡πâ‡∏£‡∏±‡∏ö‡∏ú‡∏¥‡∏î‡∏ä‡∏≠‡∏ö
    await loadHRBPCases(currentHRBP.id);

  } catch (err) {
    hideLoading();
    console.error('verifyHRBP error', err);
    alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏£‡∏´‡∏±‡∏™ HRBP\n' + (err.message || err));
  }
}
    
    // ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏à‡∏≤‡∏Å‡∏õ‡∏∏‡πà‡∏°‡πÄ‡∏°‡∏ô‡∏π HRBP
function openHRBP() {
  if (isHRBPLoggedIn && currentHRBP) {
    // ‡∏ñ‡πâ‡∏≤‡∏•‡πá‡∏≠‡∏Å‡∏≠‡∏¥‡∏ô‡πÅ‡∏•‡πâ‡∏ß ‚Üí ‡πÄ‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤ HRBP ‡πÅ‡∏•‡∏∞‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏Ñ‡∏™
    showPage('hrbp');
    loadHRBPCases(currentHRBP.id);
  } else {
    // ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏•‡πá‡∏≠‡∏Å‡∏≠‡∏¥‡∏ô ‚Üí ‡πÅ‡∏™‡∏î‡∏á modal ‡πÉ‡∏´‡πâ‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏´‡∏±‡∏™
    showHRBPLogin();
  }
}

// ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö HRBP
function logoutHRBP() {
  isHRBPLoggedIn = false;
  currentHRBP = null;

  // ‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ö‡∏ô‡∏´‡∏±‡∏ß HRBP Page
  const nameEl = document.getElementById('hrbpHeaderName');
  const mailEl = document.getElementById('hrbpHeaderEmail');
  const box    = document.getElementById('hrbpCasesContainer');

  if (nameEl) nameEl.textContent = '-';
  if (mailEl) mailEl.textContent = '-';
  if (box)    box.innerHTML = '';

  // ‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏´‡∏ï‡∏∏‡∏Å‡∏≤‡∏£‡∏ì‡πå
  showPage('report');
}
    
    function openHRMonitorLogin() {
  const modal = document.getElementById('hrMonitorLoginModal');
  const input = document.getElementById('hrMonitorEmployeeId');

  if (modal) {
    modal.classList.remove('hidden');
  }
  if (input) {
    input.value = '';
    setTimeout(() => input.focus(), 100);
  }
}

function closeHRMonitorLogin() {
  const modal = document.getElementById('hrMonitorLoginModal');
  if (modal) {
    modal.classList.add('hidden');
  }
}
    async function verifyHRMonitorAccess(e) {
  e.preventDefault();

  const input = document.getElementById('hrMonitorEmployeeId');
  const empId = (input?.value || '').trim();

  if (!empId) {
    alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏´‡∏±‡∏™‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô');
    return;
  }

  try {
    // ‡πÉ‡∏ä‡πâ popup ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö (‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô HRBP)
    showLoading('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏£‡∏´‡∏±‡∏™‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô...');

    const url = API_URL + '?action=employee&empId=' + encodeURIComponent(empId);
    const res = await fetch(url, { method: 'GET' });
    if (!res.ok) {
      throw new Error('HTTP ' + res.status);
    }

    const data = await res.json();
    if (!data.ok || !data.data) {
      alert(data.error || '‡∏£‡∏´‡∏±‡∏™‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà');
      return;
    }

    // login ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à
    isHRMonitorLoggedIn = true;
    currentHRMonitor    = data.data;

    closeHRMonitorLogin();

    // ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡∏™‡πà‡∏ß‡∏ô header ‡∏ö‡∏ô Dashboard ‡∏≠‡∏¢‡∏≤‡∏Å‡πÇ‡∏ä‡∏ß‡πå‡∏ä‡∏∑‡πà‡∏≠‡∏Å‡πá‡∏ó‡∏≥‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÑ‡∏î‡πâ ‡πÄ‡∏ä‡πà‡∏ô
    // document.getElementById('dashboardHeaderName').textContent = currentHRMonitor.EmpName || empId;

    // ‡πÅ‡∏™‡∏î‡∏á‡∏´‡∏ô‡πâ‡∏≤ Dashboard
    showPage('dashboard');

  } catch (err) {
    console.error(err);
    alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏£‡∏´‡∏±‡∏™‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô');
  } finally {
    hideLoading();
  }
}


    
    
    function viewFactoryDetails(factoryId){ showHRBPLogin(); window.selectedFactory=factoryId; }

    // ‚úÖ ‡πÄ‡∏ß‡∏≠‡∏£‡πå‡∏ä‡∏±‡∏ô‡πÉ‡∏´‡∏°‡πà ‚Äì ‡πÅ‡∏™‡∏î‡∏á loading popup ‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö + ‡πÇ‡∏´‡∏•‡∏î‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥
async function verifyHistoryAccess(e) {

  e.preventDefault();

  const input = document.getElementById('historyEmployeeId');
  const empId = (input.value || '').trim();

  if (!empId) {
    alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏´‡∏±‡∏™‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô');
    return;
  }

  try {

    // ‡πÅ‡∏™‡∏î‡∏á popup ‡∏Ç‡∏ì‡∏∞‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö / ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
    showLoading('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏£‡∏´‡∏±‡∏™‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô...');

    // ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å Google Script ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏ä‡πá‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô
    const url = API_URL + '?action=employee&empId=' + encodeURIComponent(empId);
    const res = await fetch(url, { method: 'GET' });

    if (!res.ok) {
      throw new Error('HTTP ' + res.status);
    }

    const data = await res.json();

    if (!data.ok || !data.data) {
      alert(data.error || '‡∏£‡∏´‡∏±‡∏™‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà');
      return;
    }

    // ‡πÄ‡∏Å‡πá‡∏ö‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô
    isHistoryLoggedIn = true;
    historyEmp = data.data;

    // ‡∏ã‡πà‡∏≠‡∏ô‡∏´‡∏ô‡πâ‡∏≤ login ‡πÅ‡∏•‡∏∞‡πÅ‡∏™‡∏î‡∏á‡∏™‡πà‡∏ß‡∏ô‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥
    document.getElementById('historyLoginSection').classList.add('hidden');
    document.getElementById('historyContent').classList.remove('hidden');

    // ‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏Ñ‡∏™‡∏Ç‡∏≠‡∏á‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏Ñ‡∏ô‡∏ô‡∏µ‡πâ (‡∏¢‡∏±‡∏á‡∏°‡∏µ popup ‡πÅ‡∏™‡∏î‡∏á‡∏≠‡∏¢‡∏π‡πà‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡πÇ‡∏´‡∏•‡∏î)
    await loadHistoryCases(empId);

  } catch (err) {

    console.error(err);
    alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏£‡∏´‡∏±‡∏™‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô');

  } finally {

    // ‡∏õ‡∏¥‡∏î popup ‡πÑ‡∏°‡πà‡∏ß‡πà‡∏≤‡∏à‡∏∞‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à‡∏´‡∏£‡∏∑‡∏≠ error
    hideLoading();

  }
}

function logoutHistory(){
  isHistoryLoggedIn = false;
  historyEmp = null;
  historyCases = [];
  historyCurrentRows  = [];
  historyFilterStatus = 'ALL';

  document.getElementById('historyLoginSection').classList.remove('hidden');
  document.getElementById('historyContent').classList.add('hidden');
  document.getElementById('historyEmployeeId').value = '';

  const box  = document.getElementById('searchResults');
  const wrap = document.getElementById('resultsContainer');
  if (box)  box.classList.add('hidden');
  if (wrap) wrap.innerHTML = '';

  // ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏™‡∏µ‡∏õ‡∏∏‡πà‡∏° filter ‡πÉ‡∏´‡πâ‡∏Å‡∏•‡∏±‡∏ö‡∏°‡∏≤‡∏ó‡∏µ‡πà "‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î"
  const filterBtns = document.querySelectorAll('.history-filter-btn');
  filterBtns.forEach(btn => {
    // ‡∏•‡πâ‡∏≤‡∏á‡∏™‡∏µ‡∏ó‡∏µ‡πà‡πÄ‡∏Ñ‡∏¢‡πÄ‡∏ã‡πá‡∏ï‡πÑ‡∏ß‡πâ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
    btn.classList.remove(
      'bg-blue-600','text-white',
      'bg-yellow-100','text-yellow-800',
      'bg-orange-100','text-orange-800',
      'bg-green-100','text-green-800'
    );
    // ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡πá‡∏ô‡∏õ‡∏∏‡πà‡∏°‡πÄ‡∏ó‡∏≤
    btn.classList.add('bg-gray-100','text-gray-700');

    const status = btn.getAttribute('data-history-filter') || 'ALL';
    if (status === 'ALL') {
      // ‡∏õ‡∏∏‡πà‡∏° "‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î" ‡πÄ‡∏õ‡πá‡∏ô‡∏™‡∏µ‡∏ô‡πâ‡∏≥‡πÄ‡∏á‡∏¥‡∏ô
      btn.classList.remove('bg-gray-100','text-gray-700');
      btn.classList.add('bg-blue-600','text-white');
    }
  });
}
    
/** ‚úÖ ‡∏î‡∏∂‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏Ñ‡∏™‡∏ó‡∏µ‡πà HRBP ‡∏Ñ‡∏ô‡∏´‡∏ô‡∏∂‡πà‡∏á‡∏£‡∏±‡∏ö‡∏ú‡∏¥‡∏î‡∏ä‡∏≠‡∏ö (‡∏à‡∏≤‡∏Å‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå Y ‡πÉ‡∏ô Response Form) */
async function loadHRBPCases(hrbpId) {
  if (!hrbpId) {
    alert('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏£‡∏´‡∏±‡∏™ HRBP');
    return;
  }

  try {
    const rs = await apiGet({ action: 'listbyhrbp', hrbpId });

    if (!rs.ok) {
      console.error('listbyhrbp error:', rs.error);
      alert(rs.error || '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏Ñ‡∏™‡∏Ç‡∏≠‡∏á HRBP ‡πÑ‡∏î‡πâ');
      return;
    }

    // ‡πÄ‡∏Å‡πá‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏Ñ‡∏™‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏Ç‡∏≠‡∏á HRBP ‡πÑ‡∏ß‡πâ‡πÉ‡∏ô global
    hrbpCurrentRows = rs.rows || [];

    // ‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ó‡∏µ‡πà‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡∏°‡πà ‡πÉ‡∏´‡πâ‡πÄ‡∏£‡∏¥‡πà‡∏° filter ‡∏ó‡∏µ‡πà "‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î"
    hrbpFilterStatus = 'ALL';
    setHRBPFilter('ALL');   // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡∏à‡∏∞‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ó‡∏±‡πâ‡∏á UI ‡∏õ‡∏∏‡πà‡∏° + ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å showHRBPCases() ‡πÉ‡∏´‡πâ‡πÄ‡∏≠‡∏á

  } catch (err) {
    console.error('loadHRBPCases error', err);
    alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏Ñ‡∏™‡∏Ç‡∏≠‡∏á HRBP');
  }
}
    
    // ‚úÖ ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏´‡∏ô‡πâ‡∏≤ HRBP Monitor ‡πÅ‡∏•‡∏∞‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡πÄ‡∏â‡∏û‡∏≤‡∏∞ HRBP ‡∏ó‡∏µ‡πà‡∏•‡πá‡∏≠‡∏Å‡∏≠‡∏¥‡∏ô‡∏≠‡∏¢‡∏π‡πà
async function resetHRBPPage() {
  // ‡∏ñ‡πâ‡∏≤‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏•‡πá‡∏≠‡∏Å‡∏≠‡∏¥‡∏ô HRBP ‚Üí ‡πÉ‡∏´‡πâ‡πÄ‡∏î‡πâ‡∏á modal ‡πÉ‡∏´‡πâ‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏´‡∏±‡∏™‡∏Å‡πà‡∏≠‡∏ô
  if (!currentHRBP || !currentHRBP.id) {
    showHRBPLogin();
    return;
  }

  // ‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå‡∏Å‡∏•‡πà‡∏≠‡∏á‡πÅ‡∏™‡∏î‡∏á‡πÄ‡∏Ñ‡∏™ HRBP (‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏´‡∏ô‡πâ‡∏≤ HRBP)
  const box = document.getElementById('hrbpCasesContainer');
  if (box) {
    box.innerHTML = '';
  }

  // ‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡∏Ç‡∏∂‡πâ‡∏ô‡∏ö‡∏ô‡∏™‡∏∏‡∏î‡∏Ç‡∏≠‡∏á‡∏´‡∏ô‡πâ‡∏≤ HRBP (‡∏ñ‡πâ‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£)
  const hrbpSection = document.getElementById('hrbpPage');
  if (hrbpSection && hrbpSection.scrollIntoView) {
    hrbpSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
  }

  // ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏Ñ‡∏™‡∏Ç‡∏≠‡∏á HRBP ‡∏Ñ‡∏ô‡∏ô‡∏µ‡πâ‡πÉ‡∏´‡∏°‡πà‡∏à‡∏≤‡∏Å Google Script
  await loadHRBPCases(currentHRBP.id);
}

    
    // ‚úÖ HRBP ‡∏Å‡∏î "‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏´‡∏ï‡∏∏" ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏Ñ‡∏™‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ "‡∏£‡∏≠‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö"
async function confirmHRBPCase(caseId) {
  if (!currentHRBP || !currentHRBP.id) {
    alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö HRBP ‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á');
    return;
  }

  if (!caseId) {
    alert('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏£‡∏´‡∏±‡∏™‡πÄ‡∏Ñ‡∏™');
    return;
  }

  const ok = confirm(`‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏´‡∏ï‡∏∏‡∏Ç‡∏≠‡∏á‡πÄ‡∏Ñ‡∏™ ${caseId} ‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?`);
  if (!ok) return;

  try {
    showLoading('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÄ‡∏Ñ‡∏™...');

    const res = await apiPost({
      action: 'hrbp-confirm',
      CaseId: caseId,
      HRBPId: currentHRBP.id
    });

    hideLoading();

    if (!res.ok) {
      alert(res.error || '‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
      return;
    }

    alert('‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏´‡∏ï‡∏∏‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß');

    // ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏Ñ‡∏™‡∏Ç‡∏≠‡∏á HRBP ‡∏Ñ‡∏ô‡∏ô‡∏µ‡πâ‡πÉ‡∏´‡∏°‡πà ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏õ‡∏∏‡πà‡∏°/‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏ö‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠
    await loadHRBPCases(currentHRBP.id);

  } catch (err) {
    hideLoading();
    alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÄ‡∏Ñ‡∏™\n' + (err.message || err));
  }
}

    
   function showHRBPCases(rows) {
  const box = document.getElementById('hrbpCasesContainer');
  if (!box) return;

  // ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ rows ‡∏™‡πà‡∏á‡∏°‡∏≤ ‡πÉ‡∏´‡πâ‡πÉ‡∏ä‡πâ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å global (hrbpCurrentRows)
  const sourceRows = (rows && rows.length) ? rows : (hrbpCurrentRows || []);

  box.innerHTML = '';

  if (!sourceRows.length) {
    box.innerHTML = `
      <div class="bg-white border border-dashed border-gray-300 rounded-2xl p-6 text-center text-sm text-gray-500">
        ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÄ‡∏Ñ‡∏™‡∏ó‡∏µ‡πà‡∏Ñ‡∏∏‡∏ì‡∏£‡∏±‡∏ö‡∏ú‡∏¥‡∏î‡∏ä‡∏≠‡∏ö‡πÉ‡∏ô‡∏Ç‡∏ì‡∏∞‡∏ô‡∏µ‡πâ
      </div>
    `;
    // ‡πÄ‡∏Ñ‡∏™‡πÄ‡∏õ‡πá‡∏ô 0 ‡∏Å‡πá‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡πÅ‡∏™‡∏î‡∏á pagination
    renderHRBPPagination(0);
    return;
  }

  // ----------------------------------------------------
  // ‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•: ‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏µ‡πà‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏´‡∏ï‡∏∏ + ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ + priority
  // ----------------------------------------------------
  const enriched = sourceRows.map(row => {
    const ts        = row.Timestamp ? new Date(row.Timestamp).getTime() : 0;
    const baseStatus  = String(row.Status || '').trim();
    const hrbpStatus  = String(row['Status-HRBP'] || '').trim();
    const closeStatus = String(row['Status-Close'] || '').trim();
    const isClosed    = !!closeStatus;

    let displayStatus = baseStatus || '-';
    if (isClosed) {
      displayStatus = closeStatus || '‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô-‡∏õ‡∏¥‡∏î‡πÄ‡∏Ñ‡∏™';
    } else if (hrbpStatus) {
      displayStatus = hrbpStatus;
    }

    // priority ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞
    // 1 = ‡∏£‡∏≠‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö, 2 = ‡∏£‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£/‡∏≠‡∏∑‡πà‡∏ô ‡πÜ, 3 = ‡∏õ‡∏¥‡∏î‡πÄ‡∏Ñ‡∏™ (‡∏≠‡∏¢‡∏π‡πà‡∏•‡πà‡∏≤‡∏á‡∏™‡∏∏‡∏î)
    let statusPriority = 2;
    if (displayStatus.includes('‡∏£‡∏≠‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö')) {
      statusPriority = 1;
    }
    if (isClosed) {
      statusPriority = 3;
    }

    return {
      raw: row,
      ts,
      isClosed,
      displayStatus,
      statusPriority
    };
  });

  // ----------------------------------------------------
  // ‡∏Å‡∏£‡∏≠‡∏á‡∏ï‡∏≤‡∏°‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏à‡∏≤‡∏Å hrbpFilterStatus
  // ----------------------------------------------------
  const filter = hrbpFilterStatus || 'ALL';
  let filtered = enriched;

  if (filter !== 'ALL') {
    filtered = enriched.filter(item => {
      const st = item.displayStatus;

      if (filter === '‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô-‡∏õ‡∏¥‡∏î‡πÄ‡∏Ñ‡∏™') {
        return item.isClosed ||
               st.includes('‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô') ||
               st.includes('‡∏õ‡∏¥‡∏î‡πÄ‡∏Ñ‡∏™');
      }
      return st.includes(filter);
    });
  }

  if (!filtered.length) {
    box.innerHTML = `
      <div class="bg-white border border-dashed border-gray-300 rounded-2xl p-6 text-center text-sm text-gray-500">
        ‡πÑ‡∏°‡πà‡∏û‡∏ö‡πÄ‡∏Ñ‡∏™‡∏ï‡∏≤‡∏°‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å
      </div>
    `;
    renderHRBPPagination(0);
    return;
  }

  // ----------------------------------------------------
  // ‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏•‡∏≥‡∏î‡∏±‡∏ö
  // - ‡πÄ‡∏Ñ‡∏™‡∏ó‡∏µ‡πà‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏õ‡∏¥‡∏î: ‡∏£‡∏≠‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö (1) ‚Üí ‡∏£‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£/‡∏≠‡∏∑‡πà‡∏ô ‡πÜ (2)
  //   ‡πÅ‡∏•‡∏∞‡πÉ‡∏ô‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏Å‡∏•‡∏∏‡πà‡∏°‡πÉ‡∏´‡πâ "‡πÉ‡∏´‡∏°‡πà‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î‡∏≠‡∏¢‡∏π‡πà‡∏ö‡∏ô" (ts ‡∏°‡∏≤‡∏Å ‚Üí ‡∏°‡∏≤‡∏Å‡πà‡∏≠‡∏ô)
  // - ‡πÄ‡∏Ñ‡∏™‡∏ó‡∏µ‡πà‡∏õ‡∏¥‡∏î‡πÅ‡∏•‡πâ‡∏ß: priority 3 ‡∏≠‡∏¢‡∏π‡πà‡∏•‡πà‡∏≤‡∏á‡∏™‡∏∏‡∏î ‡πÅ‡∏•‡∏∞‡πÄ‡∏£‡∏µ‡∏¢‡∏á "‡∏Å‡πà‡∏≠‡∏ô‡∏°‡∏≤‡∏´‡∏•‡∏±‡∏á"
  //   (= ‡πÄ‡∏ß‡∏•‡∏≤‡∏ô‡πâ‡∏≠‡∏¢‡∏Å‡∏ß‡πà‡∏≤‡∏≠‡∏¢‡∏π‡πà‡∏ö‡∏ô ‚Üí ‡πÄ‡∏Å‡πà‡∏≤‡∏Å‡∏ß‡πà‡∏≤‡∏≠‡∏¢‡∏π‡πà‡∏ö‡∏ô)
  // ----------------------------------------------------
  filtered.sort((a, b) => {
    if (a.statusPriority !== b.statusPriority) {
      return a.statusPriority - b.statusPriority;
    }

    // ‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏õ‡∏¥‡∏î‡πÄ‡∏Ñ‡∏™‡∏ó‡∏±‡πâ‡∏á‡∏Ñ‡∏π‡πà
    if (a.isClosed && b.isClosed) {
      // ‡πÄ‡∏Å‡πà‡∏≤‡∏Å‡∏ß‡πà‡∏≤‡∏≠‡∏¢‡∏π‡πà‡∏ö‡∏ô: ts ‡∏ô‡πâ‡∏≠‡∏¢‡∏Å‡∏ß‡πà‡∏≤ ‚Üí ‡∏°‡∏≤‡∏Å‡πà‡∏≠‡∏ô
      return a.ts - b.ts;
    }

    // ‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏õ‡∏¥‡∏î: ‡πÉ‡∏´‡∏°‡πà‡∏Å‡∏ß‡πà‡∏≤‡∏≠‡∏¢‡∏π‡πà‡∏ö‡∏ô
    return b.ts - a.ts;
  });

  // ----------------------------------------------------
  // Pagination: 15 ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ï‡πà‡∏≠‡∏´‡∏ô‡πâ‡∏≤
  // ----------------------------------------------------
  renderHRBPPagination(filtered.length);

  const pageSize = hrbpPageSize;
  const startIdx = (hrbpCurrentPage - 1) * pageSize;
  const endIdx   = startIdx + pageSize;
  const pageRows = filtered.slice(startIdx, endIdx);

  // ----------------------------------------------------
  // ‡∏ß‡∏≤‡∏î‡∏Å‡∏≤‡∏£‡πå‡∏î‡πÄ‡∏Ñ‡∏™‡∏ï‡∏≤‡∏° pageRows
  // ----------------------------------------------------
  box.innerHTML = '';

  pageRows.forEach(item => {
    const row = item.raw;

    const caseId    = String(row.CaseId || '').trim();
    const cat       = String(row.Category || '').trim();
    const subCat    = String(row.SubCategory || '').trim();
    const detail    = String(row.Detail || '').trim();
    const comment   = String(row.Comment || '').trim();
    const empName   = String(row.EmpName || '').trim();
    const empId     = String(row.EmpId   || '').trim();
    const location  = String(row.Location|| '').trim();
    const tsStr     = row.Timestamp ? String(row.Timestamp) : '';
    const rawClose  = row['Date-Close'] ? String(row['Date-Close']) : '';

    const baseStatus  = String(row.Status || '').trim();
    const hrbpStatus  = String(row['Status-HRBP'] || '').trim();
    const closeStatus = String(row['Status-Close'] || '').trim();

    const isClosed = !!closeStatus;

    let displayStatus = baseStatus || '-';
    if (isClosed) {
      displayStatus = closeStatus || '‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô-‡∏õ‡∏¥‡∏î‡πÄ‡∏Ñ‡∏™';
    } else if (hrbpStatus) {
      displayStatus = hrbpStatus;
    }

    // ‡∏™‡∏µ‡∏û‡∏∑‡πâ‡∏ô‡∏ï‡∏≤‡∏°‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞
    let tone = 'yellow';
    if (isClosed) {
      tone = 'green';
    } else if (displayStatus.includes('‡∏£‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£')) {
      tone = 'orange';
    }

    const dateDisplay  = tsStr     ? formatDateTime(tsStr)     : '-';
    const closeDisplay = rawClose  ? formatDateTime(rawClose)  : '';

    const typeText   = [cat, subCat].filter(Boolean).join(' - ') || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó';
    const reporter   = empName && empId ? `${empName} (${empId})` : (empName || empId || '-');
    const detailText = [detail, comment].filter(Boolean).join('\n\n');

    const card = document.createElement('div');
    card.className = `rounded-2xl border border-gray-200 bg-${tone}-50/60 p-4 sm:p-5 shadow-sm`;

    // ‡∏õ‡∏∏‡πà‡∏° action
    let actionLabel   = '‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î';
    let actionClass   = 'bg-blue-600 hover:bg-blue-700';
    let actionOnClick = `viewCase('${caseId}')`;

    if (!isClosed && !hrbpStatus && baseStatus.includes('‡∏£‡∏≠‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö')) {
      actionLabel   = '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏´‡∏ï‡∏∏';
      actionClass   = 'bg-green-600 hover:bg-green-700';
      actionOnClick = `confirmHRBPCase('${caseId}')`;
    }

    card.innerHTML = `
      <div class="flex flex-col sm:flex-row sm:items-start sm:justify-between gap-3">
        <div>
          <p class="text-xs text-gray-500 mb-1">‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏•‡∏Ç‡πÄ‡∏Ñ‡∏™</p>
          <h3 class="text-base sm:text-lg font-bold text-gray-800 mb-1">
            ${caseId || '-'}
          </h3>
          <p class="text-xs sm:text-sm text-gray-600 mb-1">
            ‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó: ${typeText}
          </p>
          <p class="text-xs sm:text-sm text-gray-600">
            ‡∏ú‡∏π‡πâ‡πÅ‡∏à‡πâ‡∏á: ${reporter}
          </p>
          <p class="text-xs sm:text-sm text-gray-500 mt-1">
            ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏à‡πâ‡∏á: ${dateDisplay}
          </p>
          ${location
            ? `<p class="text-[11px] sm:text-xs text-gray-500 mt-1">‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà: ${location}</p>`
            : ''
          }
          ${closeDisplay
            ? `<p class="text-[11px] sm:text-xs text-gray-400 mt-1">‡∏õ‡∏¥‡∏î‡πÄ‡∏Ñ‡∏™‡πÄ‡∏°‡∏∑‡πà‡∏≠: ${closeDisplay}</p>`
            : ''
          }
        </div>

        <div class="flex flex-col items-end gap-1.5 shrink-0">
          <span class="px-2.5 py-1 rounded-full bg-white/80 border text-[11px] sm:text-xs
                       ${isClosed ? 'border-green-300 text-green-700'
                                  : (displayStatus.includes('‡∏£‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£')
                                        ? 'border-orange-300 text-orange-700'
                                        : 'border-yellow-300 text-yellow-700')}">
            ${displayStatus}
          </span>
          <button type="button"
                  class="px-3 py-1.5 text-xs sm:text-sm rounded-md text-white ${actionClass}"
                  onclick="${actionOnClick}">
            ${actionLabel}
          </button>
        </div>
      </div>

      ${detailText
        ? `<div class="mt-3 text-xs sm:text-sm text-gray-700 bg-white/70 border border-gray-100 rounded-xl p-3 whitespace-pre-line">
             ${detailText}
           </div>`
        : ''
      }
    `;

    box.appendChild(card);
  });
}
    
    function renderHRBPPagination(totalItems) {
  const pag = document.getElementById('hrbpPagination');
  if (!pag) return;

  const pageSize   = hrbpPageSize;
  const totalPages = totalItems > 0 ? Math.ceil(totalItems / pageSize) : 1;

  if (hrbpCurrentPage > totalPages) {
    hrbpCurrentPage = totalPages;
  }

  // ‡∏ñ‡πâ‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏î‡∏µ‡∏¢‡∏ß ‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡πÅ‡∏™‡∏î‡∏á‡∏≠‡∏∞‡πÑ‡∏£
  if (totalItems === 0 || totalPages <= 1) {
    pag.innerHTML = '';
    return;
  }

  const isFirst = hrbpCurrentPage === 1;
  const isLast  = hrbpCurrentPage === totalPages;

  const prevDisabledAttr = isFirst ? 'disabled' : '';
  const nextDisabledAttr = isLast  ? 'disabled' : '';

  const prevExtraClass = isFirst ? ' opacity-40 cursor-not-allowed' : ' hover:bg-gray-100';
  const nextExtraClass = isLast  ? ' opacity-40 cursor-not-allowed' : ' hover:bg-gray-100';

  pag.innerHTML = `
    <div class="flex items-center gap-2">
      <button type="button"
              class="px-3 py-1 rounded-full border border-gray-300 bg-white text-gray-700 text-xs sm:text-sm${prevExtraClass}"
              onclick="changeHRBPPage(-1)" ${prevDisabledAttr}>
        ‚Äπ ‡∏Å‡πà‡∏≠‡∏ô‡∏´‡∏ô‡πâ‡∏≤
      </button>
    </div>

    <div class="text-xs sm:text-sm text-gray-600">
      ‡∏´‡∏ô‡πâ‡∏≤ ${hrbpCurrentPage} / ${totalPages}
      <span class="hidden sm:inline">(${totalItems} ‡πÄ‡∏Ñ‡∏™)</span>
    </div>

    <div class="flex items-center gap-2">
      <button type="button"
              class="px-3 py-1 rounded-full border border-gray-300 bg-white text-gray-700 text-xs sm:text-sm${nextExtraClass}"
              onclick="changeHRBPPage(1)" ${nextDisabledAttr}>
        ‡∏ñ‡∏±‡∏î‡πÑ‡∏õ ‚Ä∫
      </button>
    </div>
  `;
}

function changeHRBPPage(direction) {
  hrbpCurrentPage += direction;
  if (hrbpCurrentPage < 1) hrbpCurrentPage = 1;
  showHRBPCases();  // ‡∏à‡∏∞‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì filter + sort + pagination ‡πÉ‡∏´‡∏°‡πà‡∏≠‡∏µ‡∏Å‡∏£‡∏≠‡∏ö
}

    
    function setHRBPFilter(status) {
  // ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô filter ‚Üí ‡∏¢‡πâ‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤ 1 ‡πÄ‡∏™‡∏°‡∏≠
  hrbpFilterStatus = status;
  hrbpCurrentPage  = 1;

  const buttons = document.querySelectorAll('[data-hrbp-filter-btn]');

  buttons.forEach(btn => {
    const val   = btn.getAttribute('data-filter-value');
    const color = btn.getAttribute('data-color'); // gray / yellow / orange / green

    btn.classList.remove(
      'bg-gray-100', 'bg-yellow-50', 'bg-orange-50', 'bg-green-50',
      'font-semibold'
    );

    if (val === status) {
      if (color === 'yellow') {
        btn.classList.add('bg-yellow-50', 'font-semibold');
      } else if (color === 'orange') {
        btn.classList.add('bg-orange-50', 'font-semibold');
      } else if (color === 'green') {
        btn.classList.add('bg-green-50', 'font-semibold');
      } else {
        btn.classList.add('bg-gray-100', 'font-semibold');
      }
    }
  });

  showHRBPCases();
}
    

    // ‚úÖ ‡∏î‡∏∂‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏Ñ‡∏™‡∏Ç‡∏≠‡∏á‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏à‡∏≤‡∏Å Google Script ‡πÅ‡∏•‡πâ‡∏ß‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡πÉ‡∏´‡πâ‡∏´‡∏ô‡πâ‡∏≤ History ‡πÉ‡∏ä‡πâ
async function loadHistoryCases(empId){
  try{
    const rs = await apiGet({ action:'listbyemp', empId });

    if (!rs.ok){
      alert(rs.error || '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏Ñ‡∏™‡πÑ‡∏î‡πâ');
      historyCases = [];
      showSearchResults([]);
      return;
    }

    // ‡πÄ‡∏Å‡πá‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏î‡∏¥‡∏ö‡∏à‡∏≤‡∏Å‡∏ä‡∏µ‡∏ï Response Form ‡πÑ‡∏ß‡πâ‡πÉ‡∏ä‡πâ‡∏ï‡πà‡∏≠ (searchByCase, viewCase)
    historyCases = rs.rows || [];

    if (!historyCases.length){
      showSearchResults([]);
      return;
    }

    // ‡πÅ‡∏õ‡∏•‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡πá‡∏ô‡∏£‡∏π‡∏õ‡∏ó‡∏µ‡πà showSearchResults ‡πÉ‡∏ä‡πâ (‡πÉ‡∏ä‡πâ logic ‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ö searchByCase)
    const mapped = historyCases.map(r => {
      const baseStatus  = String(r['Status'] || '').trim();          // S
      const hrbpStatus  = String(r['Status-HRBP'] || '').trim();     // T
      const closeStatus = String(r['Status-Close'] || '').trim();
      const closeRaw    = r['Date-Close'] ? String(r['Date-Close']) : '';
      const closeAtDisplay = closeRaw ? formatDateTime(closeRaw) : '';

      const caseId2  = String(r['CaseId'] || '').trim();

      const rawTimestamp = r['Timestamp'] ? String(r['Timestamp']) : '';
      const dateRaw      = rawTimestamp;
      const dateDisplay  = rawTimestamp ? formatDateTime(rawTimestamp) : '';

      const empName  = String(r['EmpName'] || '').trim();
      const empIdVal = String(r['EmpId']   || '').trim();

      const typeText = [
        String(r['Category']    || '').trim(),
        String(r['SubCategory'] || '').trim()
      ].filter(Boolean).join(' - ') || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó';

      const detailMain = String(r['Detail']  || '').trim();
      const comment    = String(r['Comment'] || '').trim();
      const detailText = [detailMain, comment].filter(Boolean).join('\n\n');

      const isClosed = !!closeStatus;

      let statusDisplay = baseStatus || '-';
      if (isClosed) {
        statusDisplay = closeStatus || '‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô-‡∏õ‡∏¥‡∏î‡πÄ‡∏Ñ‡∏™';
      } else if (hrbpStatus) {
        statusDisplay = hrbpStatus;
      }

      return {
        id:   caseId2,
        type: typeText,          // ‚úÖ ‡πÄ‡∏û‡∏¥‡πà‡∏° type ‡πÉ‡∏´‡πâ‡πÉ‡∏ä‡πâ‡πÉ‡∏ô‡∏´‡∏ô‡πâ‡∏≤ History

        dateRaw:     dateRaw,    // ‚úÖ ‡πÄ‡∏Å‡πá‡∏ö raw ‡πÑ‡∏ß‡πâ sort
        date:        dateRaw,    // ‡πÉ‡∏ä‡πâ‡∏™‡∏≥‡∏£‡∏≠‡∏á‡∏ñ‡πâ‡∏≤ dateDisplay ‡πÑ‡∏°‡πà‡∏°‡∏µ
        dateDisplay: dateDisplay,

        employee:
          empName && empIdVal
            ? `${empName} (${empIdVal})`
            : (empName || empIdVal || ''),

        status:     statusDisplay,
        baseStatus: baseStatus,
        hrbpStatus: hrbpStatus,
        isClosed:   isClosed,

        closedAt:  closeAtDisplay,
        closedRaw: closeRaw,

        details:   detailText
      };
    });

    // ‡∏™‡πà‡∏á‡πÉ‡∏´‡πâ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏Ç‡∏≠‡∏á‡∏´‡∏ô‡πâ‡∏≤ History
    showSearchResults(mapped);

  }catch(err){
    console.error('loadHistoryCases error', err);
    alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏Ñ‡∏™‡∏Ç‡∏≠‡∏á‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô');
  }
}



    function searchByCase(){
  const caseId = document.getElementById('caseSearch').value.trim();
  if (!caseId){
    alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏´‡∏±‡∏™‡πÄ‡∏Ñ‡∏™');
    return;
  }

  if (!Array.isArray(historyCases) || !historyCases.length){
    alert('‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏Ñ‡∏™‡∏Ç‡∏≠‡∏á‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏Ñ‡∏ô‡∏ô‡∏µ‡πâ');
    return;
  }

  // ‡∏´‡∏≤‡πÄ‡∏Ñ‡∏™‡∏ó‡∏µ‡πà caseId ‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ô‡∏à‡∏≤‡∏Å historyCases
  const target = historyCases.filter(r =>
    String(r['CaseId'] || '').trim().toUpperCase() === caseId.toUpperCase()
  );

  if (!target.length){
    alert('‡πÑ‡∏°‡πà‡∏û‡∏ö‡πÄ‡∏Ñ‡∏™‡∏ó‡∏µ‡πà‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤');
    return;
  }

  const mapped = target.map(r => {
    const baseStatus  = String(r['Status'] || '').trim();          // S
    const hrbpStatus  = String(r['Status-HRBP'] || '').trim();     // T
    const closeStatus = String(r['Status-Close'] || '').trim();
    const closeRaw    = r['Date-Close'] ? String(r['Date-Close']) : '';
    const closeAtDisplay = closeRaw ? formatDateTime(closeRaw) : '';

    const caseId2  = String(r['CaseId'] || '').trim();

    const rawTimestamp = r['Timestamp'] ? String(r['Timestamp']) : '';
    const dateRaw      = rawTimestamp;
    const dateDisplay  = rawTimestamp ? formatDateTime(rawTimestamp) : '';
    
    const empName  = String(r['EmpName'] || '').trim();
    const empIdVal = String(r['EmpId']   || '').trim();

    const typeText = [
      String(r['Category']    || '').trim(),
      String(r['SubCategory'] || '').trim()
    ].filter(Boolean).join(' - ') || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó';

    const detailText =
      String(r['Detail']  || '').trim() ||
      String(r['Comment'] || '').trim() || '';

    const isClosed = !!closeStatus;

    let statusDisplay = baseStatus || '-';
    if (isClosed) {
      statusDisplay = closeStatus || '‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô-‡∏õ‡∏¥‡∏î‡πÄ‡∏Ñ‡∏™';
    } else if (hrbpStatus) {
      statusDisplay = hrbpStatus;
    }

    return {
      id:         caseId2,
      type:       typeText,

      date:          dateRaw,       // ‡πÉ‡∏ä‡πâ sort
      dateDisplay:   dateDisplay,   // ‡πÉ‡∏ä‡πâ‡πÅ‡∏™‡∏î‡∏á

      employee:   empName && empIdVal ? `${empName} (${empIdVal})` : (empName || empIdVal || ''),
      status:     statusDisplay,
      baseStatus: baseStatus,
      hrbpStatus: hrbpStatus,
      isClosed:   isClosed,

      closedAt:      closeAtDisplay, // ‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•
      closedRaw:     closeRaw,       // sort

      details:    detailText
    };
  });

  showSearchResults(mapped);
}

    function showSearchResults(rows) {

  const wrap = document.getElementById('resultsContainer');
  const box  = document.getElementById('searchResults');

  // ‡πÄ‡∏Å‡πá‡∏ö rows ‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡πÑ‡∏ß‡πâ‡πÉ‡∏ä‡πâ‡∏ï‡∏≠‡∏ô‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏° Filter
  historyCurrentRows = rows || [];

  wrap.innerHTML = '';

  if (!historyCurrentRows || !historyCurrentRows.length) {
    box.classList.add('hidden');
    return;
  }

  // ---------- ‡∏Å‡∏£‡∏≠‡∏á‡∏ï‡∏≤‡∏°‡∏õ‡∏∏‡πà‡∏°‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å ----------
  let rowsToRender = historyCurrentRows;

  if (historyFilterStatus && historyFilterStatus !== 'ALL') {
    rowsToRender = historyCurrentRows.filter(r => {

      if (historyFilterStatus === '‡∏õ‡∏¥‡∏î‡πÄ‡∏Ñ‡∏™') {
        // ‡∏õ‡∏¥‡∏î‡πÄ‡∏Ñ‡∏™ ‚Üí ‡∏î‡∏π‡∏à‡∏≤‡∏Å‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå V (isClosed = true)
        return !!r.isClosed;
      }

      if (historyFilterStatus === '‡∏£‡∏≠‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö') {
        // ‡∏£‡∏≠‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö ‚Üí ‡∏î‡∏π‡∏à‡∏≤‡∏Å‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå S (baseStatus)
        return !r.isClosed && (r.baseStatus || '').includes('‡∏£‡∏≠‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö');
      }

      if (historyFilterStatus === '‡∏£‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£') {
        // ‡∏£‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£ ‚Üí ‡∏î‡∏π‡∏à‡∏≤‡∏Å‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå T (Status-HRBP)
        return !r.isClosed && (r.hrbpStatus || '').includes('‡∏£‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£');
      }

      // ‡∏Å‡∏£‡∏ì‡∏µ‡∏≠‡∏∑‡πà‡∏ô (‡∏Å‡∏±‡∏ô‡∏û‡∏•‡∏≤‡∏î) ‚Üí ‡πÅ‡∏™‡∏î‡∏á‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
      return true;
    });
  }

  if (!rowsToRender.length) {
    box.classList.remove('hidden');
    wrap.innerHTML = `
      <p class="text-sm text-gray-500 mt-1">
        ‡πÑ‡∏°‡πà‡∏û‡∏ö‡πÄ‡∏Ñ‡∏™‡∏ï‡∏≤‡∏°‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å
      </p>
    `;
    return;
  }

  // ---------- ‡∏à‡∏±‡∏î‡πÄ‡∏£‡∏µ‡∏¢‡∏á (Sort) ----------
  // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ä‡πà‡∏ß‡∏¢‡πÅ‡∏õ‡∏•‡∏á string ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà ‚Üí ‡πÄ‡∏ß‡∏•‡∏≤ (ms)
  const parseTime = (val) => {
    if (!val) return 0;
    // ‡∏û‡∏¢‡∏≤‡∏¢‡∏≤‡∏°‡πÅ‡∏õ‡∏•‡∏á "yyyy-MM-dd HH:mm:ss" ‡∏´‡∏£‡∏∑‡∏≠ format ‡πÉ‡∏Å‡∏•‡πâ‡πÄ‡∏Ñ‡∏µ‡∏¢‡∏á
    const iso = String(val).replace(' ', 'T');
    const t = Date.parse(iso);
    return isNaN(t) ? 0 : t;
  };

  rowsToRender = [...rowsToRender].sort((a, b) => {

    const aClosed = !!a.isClosed;
    const bClosed = !!b.isClosed;

    // ‡πÄ‡∏Ñ‡∏™‡πÄ‡∏õ‡∏¥‡∏î‡∏≠‡∏¢‡∏π‡πà‡∏Ç‡∏∂‡πâ‡∏ô‡∏Å‡πà‡∏≠‡∏ô ‡∏ñ‡πâ‡∏≤ filter = ALL
    if (historyFilterStatus === 'ALL') {
      if (aClosed !== bClosed) {
        return aClosed ? 1 : -1;
      }
    }

    // ‡πÉ‡∏ä‡πâ raw time ‡πÉ‡∏ô‡∏Å‡∏≤‡∏£ sort ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÑ‡∏°‡πà‡πÉ‡∏´‡πâ format ‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢‡∏ó‡∏≥‡πÉ‡∏´‡πâ parseTime ‡∏û‡∏±‡∏á
    const aKey = (historyFilterStatus === '‡∏õ‡∏¥‡∏î‡πÄ‡∏Ñ‡∏™' && a.closedRaw)
      ? a.closedRaw
      : (a.dateRaw || a.date);

    const bKey = (historyFilterStatus === '‡∏õ‡∏¥‡∏î‡πÄ‡∏Ñ‡∏™' && b.closedRaw)
      ? b.closedRaw
      : (b.dateRaw || b.date);

    const tA = parseTime(aKey);
    const tB = parseTime(bKey);

    return tB - tA; // ‡πÉ‡∏´‡∏°‡πà‡∏™‡∏∏‡∏î‡∏°‡∏≤‡∏Å‡πà‡∏≠‡∏ô
  });
  // ---------- ‡∏ß‡∏≤‡∏î‡∏Å‡∏≤‡∏£‡πå‡∏î ----------
 rowsToRender.forEach(r => {

    // ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡πÇ‡∏ó‡∏ô‡∏™‡∏µ‡∏ï‡∏≤‡∏°‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞
    //  - ‡∏£‡∏≠‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö      ‚Üí ‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏á
    //  - ‡∏£‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£    ‚Üí ‡∏™‡πâ‡∏°
    //  - ‡∏õ‡∏¥‡∏î‡πÄ‡∏Ñ‡∏™ / ‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô ‚Üí ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß
    let tone = 'yellow'; // ‡∏Ñ‡πà‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô = ‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏á (‡∏£‡∏≠‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö)

    if (r.isClosed) {
      tone = 'green';
    } else if (r.status && r.status.includes('‡∏£‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£')) {
      tone = 'orange';
    }

    // ‡πÉ‡∏ä‡πâ‡∏™‡∏µ‡∏≠‡πà‡∏≠‡∏ô‡∏°‡∏≤‡∏Å (50) ‡∏Å‡∏±‡∏ö‡∏û‡∏∑‡πâ‡∏ô‡∏´‡∏•‡∏±‡∏á‡∏Å‡∏≤‡∏£‡πå‡∏î ‡πÅ‡∏•‡∏∞‡πÉ‡∏ä‡πâ 50 + text-700 ‡∏Å‡∏±‡∏ö badge ‡πÉ‡∏´‡πâ‡∏î‡∏π‡∏ã‡∏≠‡∏ü‡∏ó‡πå
    const bgColorClass = `bg-${tone}-50`;
    const statusColor  = tone;

    const card = document.createElement('div');
    card.className = `${bgColorClass} rounded-xl p-4 sm:p-5 shadow-sm border border-gray-200`;

    card.innerHTML = `
      <div class="flex justify-between items-start gap-3">
        <div>
          <h4 class="text-base sm:text-lg font-bold text-gray-800 mb-1">
            ${[r.id, r.type].filter(Boolean).join(' - ')}
          </h4>
          <p class="text-gray-600 text-xs sm:text-sm mb-1">
            ‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô: ${r.employee || '-'}
          </p>
          <p class="text-gray-500 text-xs sm:text-sm">
            ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà: ${r.dateDisplay || r.date || '-'}
          </p>
          <p class="text-gray-500 text-xs sm:text-sm mt-1">
            ${r.details || ''}
          </p>
          ${r.isClosed && (r.closedAt || r.closedRaw)
            ? `<p class="text-[11px] sm:text-xs text-gray-400 mt-1">
                 ‡∏õ‡∏¥‡∏î‡πÄ‡∏Ñ‡∏™‡πÄ‡∏°‡∏∑‡πà‡∏≠: ${r.closedAt || (r.closedRaw ? formatDateTime(r.closedRaw) : '')}
               </p>`
            : ''
          }
        </div>

        <div class="flex flex-col items-end gap-1.5">
          <span class="px-2.5 py-1 bg-${statusColor}-50 text-${statusColor}-700 text-[11px] sm:text-xs rounded-full">
            ${r.status}
          </span>

          <button
            onclick="viewCaseHistory('${r.id}')"
            class="px-3 py-1 bg-blue-600 text-white rounded-md hover:bg-blue-700 text-xs sm:text-sm">
            ‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î
          </button>

          ${!r.isClosed
            ? `<button onclick="closeCaseByEmployee('${r.id}')"
                 class="px-3 py-1 bg-green-600 text-white rounded-md hover:bg-green-700 text-xs sm:text-sm">
                 ‡∏õ‡∏¥‡∏î‡πÄ‡∏Ñ‡∏™
               </button>`
            : ''
          }
        </div>
      </div>
    `;

    wrap.appendChild(card);
});

  box.classList.remove('hidden');
}

// Event ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏õ‡∏∏‡πà‡∏°‡∏Å‡∏£‡∏≠‡∏á‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÉ‡∏ô‡∏´‡∏ô‡πâ‡∏≤ History
document.addEventListener('DOMContentLoaded', () => {
  const filterBtns = document.querySelectorAll('.history-filter-btn');

  filterBtns.forEach(btn => {
    btn.addEventListener('click', () => {
      const status = btn.getAttribute('data-history-filter') || 'ALL';
      historyFilterStatus = status;

      // ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏õ‡∏∏‡πà‡∏°‡∏ó‡∏∏‡∏Å‡∏≠‡∏±‡∏ô‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡πá‡∏ô‡πÇ‡∏´‡∏°‡∏î "‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å" = ‡πÄ‡∏ó‡∏≤
      filterBtns.forEach(b => {
        b.classList.remove(
          'bg-blue-600','text-white',
          'bg-yellow-100','text-yellow-800',
          'bg-orange-100','text-orange-800',
          'bg-green-100','text-green-800'
        );
        b.classList.add('bg-gray-100','text-gray-700');
      });

      // ‡∏ï‡∏±‡πâ‡∏á‡∏™‡∏µ‡∏ï‡∏≤‡∏°‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å
      btn.classList.remove('bg-gray-100','text-gray-700');

      if (status === 'ALL') {
        // ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î = ‡∏ü‡πâ‡∏≤
        btn.classList.add('bg-blue-600','text-white');
      } else if (status === '‡∏£‡∏≠‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö') {
        // ‡∏£‡∏≠‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö = ‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏á‡∏≠‡πà‡∏≠‡∏ô
        btn.classList.add('bg-yellow-100','text-yellow-800');
      } else if (status === '‡∏£‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£') {
        // ‡∏£‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£ = ‡∏™‡πâ‡∏°
        btn.classList.add('bg-orange-100','text-orange-800');
      } else if (status === '‡∏õ‡∏¥‡∏î‡πÄ‡∏Ñ‡∏™') {
        // ‡∏õ‡∏¥‡∏î‡πÄ‡∏Ñ‡∏™ = ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß‡∏≠‡πà‡∏≠‡∏ô
        btn.classList.add('bg-green-100','text-green-800');
      }

      // ‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡πÉ‡∏´‡∏°‡πà‡∏ï‡∏≤‡∏° filter ‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å
      showSearchResults(historyCurrentRows);
    });
  });
});

    function viewCaseHistory(id){ viewCase(id); }
    async function closeCaseByEmployee(id){
  if (!historyEmp || !historyEmp.empId){
    alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡πá‡∏≠‡∏Å‡∏≠‡∏¥‡∏ô‡∏î‡πâ‡∏ß‡∏¢‡∏£‡∏´‡∏±‡∏™‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏Å‡πà‡∏≠‡∏ô');
    return;
  }

  if (!confirm(`‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏õ‡∏¥‡∏î‡πÄ‡∏Ñ‡∏™ ${id} ‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?`)){
    return;
  }

  try{
    const res = await apiPost({
      action: 'close',
      CaseId: id,
      EmpId:  historyEmp.empId
    });

    if (!res.ok){
      alert(res.error || '‡∏õ‡∏¥‡∏î‡πÄ‡∏Ñ‡∏™‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
      return;
    }

    alert(`‡πÄ‡∏Ñ‡∏™ ${id} ‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏õ‡∏¥‡∏î‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß`);

    // ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏Ñ‡∏™‡πÉ‡∏´‡∏°‡πà‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏ö‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠
    await loadHistoryCases(historyEmp.empId);

  }catch(err){
    console.error(err);
    alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏õ‡∏¥‡∏î‡πÄ‡∏Ñ‡∏™');
  }
}

    async function viewCase(id){
  let row = null;

  // 1) ‡∏û‡∏¢‡∏≤‡∏¢‡∏≤‡∏°‡∏´‡∏≤‡πÄ‡∏Ñ‡∏™‡∏à‡∏≤‡∏Å historyCases ‡∏Å‡πà‡∏≠‡∏ô
  if (Array.isArray(historyCases) && historyCases.length){
    row = historyCases.find(r =>
      String(r['CaseId'] || '').trim() === String(id).trim()
    );
  }

  // 2) ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡πÄ‡∏à‡∏≠ ‡∏•‡∏≠‡∏á‡∏ñ‡∏≤‡∏° Apps Script ‡∏î‡πâ‡∏ß‡∏¢ action=getbyid (‡πÉ‡∏´‡πâ‡πÉ‡∏ä‡πâ rs.data ‡πÉ‡∏´‡πâ‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö‡∏ù‡∏±‡πà‡∏á Apps Script)
  if (!row){
    try{
      const rs = await apiGet({ action:'getbyid', caseId: id });
      if (rs.ok && rs.data){
        row = rs.data;   // ‚Üê ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏à‡∏≤‡∏Å rs.obj ‡πÄ‡∏õ‡πá‡∏ô rs.data
      }
    }catch(err){
      console.error(err);
    }
  }

  if (!row){
    alert('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏Ñ‡∏™');
    return;
  }

  const caseId   = String(row['CaseId']   || '').trim();
  const category = String(row['Category'] || '').trim();
  const subCat   = String(row['SubCategory'] || '').trim();
  const typeText = [category, subCat].filter(Boolean).join(' - ');

  const status   = String(row['Status']   || '').trim() || '-';
  const location = String(row['Location'] || '').trim();
 const ts       = row['Timestamp'];

  let dateText = '';
  let timeText = '';

  if (ts) {
    // ‡πÉ‡∏ä‡πâ‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤ list
    const formatted = formatDateTime(String(ts));
    dateText = formatted;   // ‡πÄ‡∏≠‡∏≤‡πÑ‡∏õ‡πÅ‡∏™‡∏î‡∏á‡∏£‡∏ß‡∏°‡πÄ‡∏õ‡πá‡∏ô "‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏•‡∏∞‡πÄ‡∏ß‡∏•‡∏≤"
  }

  const empName  = String(row['EmpName'] || '').trim();
  const empId    = String(row['EmpId']   || '').trim();
  const reporter = empName && empId ? `${empName} (${empId})` : (empName || empId || '');

  const detailMain = String(row['Detail']  || '').trim();
  const comment    = String(row['Comment'] || '').trim();
  const details    = [detailMain, comment].filter(Boolean).join('\n\n');

  document.getElementById('caseTitle').textContent =
    (caseId ? caseId + ' - ' : '') + (typeText || '‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡πÄ‡∏Ñ‡∏™');

  document.getElementById('caseContent').innerHTML = `
    <div class="grid md:grid-cols-2 gap-4">
      <div><strong>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞:</strong> ${status}</div>
      <div><strong>‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó:</strong> ${typeText || '-'}</div>
      <div><strong>‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà:</strong> ${location || '-'}</div>
      <div><strong>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏•‡∏∞‡πÄ‡∏ß‡∏•‡∏≤:</strong> ${dateText || '-'}</div>
      <div><strong>‡∏ú‡∏π‡πâ‡πÅ‡∏à‡πâ‡∏á:</strong> ${reporter || '-'}</div>
    </div>
    <div class="mt-4">
      <strong>‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î:</strong>
      <p class="mt-2 p-4 bg-gray-50 rounded-lg whitespace-pre-line">${details || '-'}</p>
    </div>
  `;

  document.getElementById('caseModal').classList.remove('hidden');
}
    
    function closeCaseModal(){ document.getElementById('caseModal').classList.add('hidden'); }

    /** ---------- ‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡∏¥‡∏î‡πÄ‡∏´‡∏ï‡∏∏: ‡πÇ‡∏´‡∏•‡∏î‡∏à‡∏≤‡∏Å‡∏ä‡∏µ‡∏ï + ‡πÅ‡∏Ñ‡∏ä (Format + Location) --------- */

let _LOCATION_ROWS = null; // [{ format, location }]

async function ensureLocations(){
  if (Array.isArray(_LOCATION_ROWS)) return _LOCATION_ROWS;

  try{
    const rs = await apiGet({ action:'locations' });
    _LOCATION_ROWS = (rs.ok ? rs.rows : []) || [];
  }catch{
    _LOCATION_ROWS = [];
  }
  return _LOCATION_ROWS;
}

let _locDebounce = 0;

async function typeaheadLocation(q){
  const dropdown = document.getElementById('locationDropdown');
  const input    = document.getElementById('locationInput');
  const fmtInput = document.getElementById('locationFormat');

  clearTimeout(_locDebounce);
  _locDebounce = setTimeout(async () => {
    const currentFmt = (fmtInput && fmtInput.value ? fmtInput.value.trim().toLowerCase() : '');

    // ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ó‡∏±‡πâ‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÅ‡∏•‡∏∞‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å Format ‡πÄ‡∏•‡∏¢ ‚Üí ‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡πÇ‡∏ä‡∏ß‡πå
    if (!q && !currentFmt){
      dropdown.classList.add('hidden');
      return;
    }

    const items = await ensureLocations(); // [{format, location}]
    let list = items;

    // ‡∏ñ‡πâ‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å Format ‡πÅ‡∏•‡πâ‡∏ß ‚Üí ‡∏Å‡∏£‡∏≠‡∏á‡πÄ‡∏â‡∏û‡∏≤‡∏∞ Location ‡πÉ‡∏ô Format ‡∏ô‡∏±‡πâ‡∏ô
    if (currentFmt){
      list = list.filter(row =>
        String(row.format || '').trim().toLowerCase() === currentFmt
      );
    }

    if (q){
      const qLower = q.toLowerCase();
      list = list.filter(row =>
        String(row.location || '').toLowerCase().includes(qLower)
      );
    }

    list = list.slice(0, 50);

    if (!list.length){
      dropdown.classList.add('hidden');
      return;
    }

    dropdown.innerHTML = '';
    list.forEach(row => {
      const loc = row.location || '';
      const fmt = row.format || '';

      const div = document.createElement('div');
      div.className =
        'px-4 py-2 hover:bg-blue-50 cursor-pointer text-sm border-b border-gray-100 last:border-b-0';
      // ‡πÅ‡∏™‡∏î‡∏á Format ‡∏Å‡∏≥‡∏Å‡∏±‡∏ö‡πÄ‡∏•‡πá‡∏Å‡∏ô‡πâ‡∏≠‡∏¢‡πÉ‡∏´‡πâ‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡πÄ‡∏´‡πá‡∏ô context
      div.textContent = fmt ? `${loc} (${fmt})` : loc;

      div.onclick = () => {
        input.value = loc;
        // ‡∏ñ‡πâ‡∏≤‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏Å‡∏£‡∏≠‡∏Å Format ‚Üí ‡πÄ‡∏ï‡∏¥‡∏° Format ‡∏ï‡∏≤‡∏° Location ‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å
        if (fmtInput && !fmtInput.value.trim()){
          fmtInput.value = fmt;
        }
        dropdown.classList.add('hidden');
      };

      dropdown.appendChild(div);
    });

    dropdown.classList.remove('hidden');
  }, 150);
}

// ‡∏õ‡∏¥‡∏î dropdown ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏Ñ‡∏•‡∏¥‡∏Å‡∏ô‡∏≠‡∏Å
document.addEventListener('click', (e)=>{
  const t = e.target;

  const locDropdown = document.getElementById('locationDropdown');
  const locInput    = document.getElementById('locationInput');
  const locBtn      = document.getElementById('locationToggleBtn');

  const fmtDropdown = document.getElementById('formatDropdown');
  const fmtInput    = document.getElementById('locationFormat');
  const fmtBtn      = document.getElementById('formatToggleBtn');

  if (locDropdown && !locDropdown.contains(t) && t !== locInput && t !== locBtn){
    locDropdown.classList.add('hidden');
  }
  if (fmtDropdown && !fmtDropdown.contains(t) && t !== fmtInput && t !== fmtBtn){
    fmtDropdown.classList.add('hidden');
  }
});
    /** ---------- Format: ‡πÇ‡∏´‡∏•‡∏î‡∏à‡∏≤‡∏Å‡∏ä‡∏µ‡∏ï (‡∏´‡∏£‡∏∑‡∏≠ fallback) + ‡πÅ‡∏Ñ‡∏ä --------- */
let _FORMATS = null; // ‡πÅ‡∏Ñ‡∏ä‡πÉ‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡∏ô‡∏µ‡πâ

async function ensureFormats(){
  if (Array.isArray(_FORMATS)) return _FORMATS;
  try{
    // ‡∏ù‡∏±‡πà‡∏á Apps Script ‡∏Ñ‡∏ß‡∏£‡∏ó‡∏≥ action=formats (‡πÄ‡∏ä‡πà‡∏ô ‡∏≠‡πà‡∏≤‡∏ô‡∏ä‡∏µ‡∏ï "‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡∏¥‡∏î‡πÄ‡∏´‡∏ï‡∏∏" ‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå A ‡∏´‡∏£‡∏∑‡∏≠‡∏ä‡∏µ‡∏ï‡∏ó‡∏µ‡πà‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£)
    const rs = await apiGet({ action:'formats' });
    _FORMATS = (rs.ok ? rs.rows : []) || [];
  }catch{
    // ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ endpoint ‡∏Å‡πá‡∏°‡∏µ fallback ‡∏û‡∏∑‡πâ‡∏ô‡∏ê‡∏≤‡∏ô
    _FORMATS = ['‡∏ä‡∏±‡πâ‡∏ô 1','‡∏ä‡∏±‡πâ‡∏ô 2','‡∏≠‡∏≤‡∏Ñ‡∏≤‡∏£ A','‡∏≠‡∏≤‡∏Ñ‡∏≤‡∏£ B','‡πÇ‡∏ã‡∏ô‡∏ú‡∏•‡∏¥‡∏ï A','‡πÇ‡∏ã‡∏ô‡∏ú‡∏•‡∏¥‡∏ï B'];
  }
  return _FORMATS;
}

let _fmtDebounce = 0;
async function typeaheadFormat(q){
  const dropdown = document.getElementById('formatDropdown');
  const input    = document.getElementById('locationFormat');

  clearTimeout(_fmtDebounce);
  _fmtDebounce = setTimeout(async () => {
    if (!q) { dropdown.classList.add('hidden'); return; }

    const items = await ensureFormats();
    const list = items
      .map(v => String(v || ''))
      .filter(v => v.toLowerCase().includes(q.toLowerCase()))
      .slice(0, 50);

    if (list.length === 0){ dropdown.classList.add('hidden'); return; }

    dropdown.innerHTML = '';
    list.forEach(fmt => {
      const div = document.createElement('div');
      div.className = 'px-4 py-2 hover:bg-blue-50 cursor-pointer text-sm border-b border-gray-100 last:border-b-0';
      div.textContent = fmt;
      div.onclick = () => { input.value = fmt; dropdown.classList.add('hidden'); };
      dropdown.appendChild(div);
    });
    dropdown.classList.remove('hidden');
  }, 150);
}

async function toggleFormatDropdown(forceOpen){
  const dropdown = document.getElementById('formatDropdown');
  const input    = document.getElementById('locationFormat');

  const shouldOpen = (typeof forceOpen === 'boolean')
    ? forceOpen
    : dropdown.classList.contains('hidden');

  if (!shouldOpen){ dropdown.classList.add('hidden'); return; }

  const items = await ensureFormats();
  const list = items.slice(0, 100);

  dropdown.innerHTML = '';
  list.forEach(fmt => {
    const div = document.createElement('div');
    div.className = 'px-4 py-2 hover:bg-blue-50 cursor-pointer text-sm border-b border-gray-100 last:border-b-0';
    div.textContent = fmt;
    div.onclick = () => { input.value = fmt; dropdown.classList.add('hidden'); };
    dropdown.appendChild(div);
  });
  dropdown.classList.remove('hidden');
}

    async function toggleLocationDropdown(forceOpen){
  const dropdown = document.getElementById('locationDropdown');
  const input    = document.getElementById('locationInput');
  const fmtInput = document.getElementById('locationFormat');

  const shouldOpen = (typeof forceOpen === 'boolean')
    ? forceOpen
    : dropdown.classList.contains('hidden');

  if (!shouldOpen){
    dropdown.classList.add('hidden');
    return;
  }

  const items = await ensureLocations(); // [{format, location}]
  const currentFmt = (fmtInput && fmtInput.value ? fmtInput.value.trim().toLowerCase() : '');

  let list = items;

  // ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ Format ‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß ‚Üí ‡πÅ‡∏™‡∏î‡∏á‡πÄ‡∏â‡∏û‡∏≤‡∏∞ Location ‡πÉ‡∏ô Format ‡∏ô‡∏±‡πâ‡∏ô
  if (currentFmt){
    list = list.filter(row =>
      String(row.format || '').trim().toLowerCase() === currentFmt
    );
  }

  list = list.slice(0, 100);

  if (!list.length){
    dropdown.classList.add('hidden');
    return;
  }

  dropdown.innerHTML = '';
  list.forEach(row => {
    const loc = row.location || '';
    const fmt = row.format || '';

    const div = document.createElement('div');
    div.className =
      'px-4 py-2 hover:bg-blue-50 cursor-pointer text-sm border-b border-gray-100 last:border-b-0';
    div.textContent = fmt ? `${loc} (${fmt})` : loc;

    div.onclick = () => {
      input.value = loc;
      if (fmtInput && !fmtInput.value.trim()){
        fmtInput.value = fmt;
      }
      dropdown.classList.add('hidden');
    };

    dropdown.appendChild(div);
  });

  dropdown.classList.remove('hidden');
}

/** ---------- ‡πÅ‡∏ô‡∏ö‡∏£‡∏π‡∏õ: ‡∏û‡∏£‡∏µ‡∏ß‡∏¥‡∏ß + ‡∏•‡∏ö‡πÑ‡∏ü‡∏•‡πå‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å ---------- */
const MAX_FILES = 10;
const MAX_SIZE  = 5 * 1024 * 1024; // 5MB/‡πÑ‡∏ü‡∏•‡πå
const MAX_TOTAL_UPLOAD = 20 * 1024 * 1024; // 20MB ‡∏£‡∏ß‡∏°
const ACCEPTED_TYPES = ['image/png','image/jpeg','image/jpg','image/heic','image/heif','image/webp'];

const fileInput = document.getElementById('incidentPhotos');
const previewEl = document.getElementById('photoPreview');

// ‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤‡πÑ‡∏ü‡∏•‡πå‡∏ó‡∏µ‡πà‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å (‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÑ‡∏î‡πâ)
let uploadDT = new DataTransfer();

fileInput.addEventListener('change', onSelectFiles);

function onSelectFiles(e){
  const incoming = Array.from(e.target.files || []);

  // ‡πÄ‡∏ï‡∏¥‡∏°‡πÄ‡∏Ç‡πâ‡∏≤‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤ (‡∏ï‡∏£‡∏ß‡∏à‡∏ó‡∏µ‡∏•‡∏∞‡πÑ‡∏ü‡∏•‡πå)
  for (const f of incoming){
    if (uploadDT.files.length >= MAX_FILES) { alert(`‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏î‡πâ‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î ${MAX_FILES} ‡∏£‡∏π‡∏õ`); break; }

    const ext = (f.name.split('.').pop()||'').toLowerCase();
    const mimeOk = /^image\//i.test(f.type) || ACCEPTED_TYPES.includes(f.type);
    const extOk  = ['png','jpg','jpeg','heic','heif','webp'].includes(ext);
    if (!mimeOk && !extOk) { alert(`‡πÑ‡∏ü‡∏•‡πå "${f.name}" ‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡∏ó‡∏µ‡πà‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö`); continue; }
    if (f.size > MAX_SIZE) { alert(`‡πÑ‡∏ü‡∏•‡πå "${f.name}" ‡πÄ‡∏Å‡∏¥‡∏ô 5MB`); continue; }

    uploadDT.items.add(f);
  }

  // ‡∏ï‡∏£‡∏ß‡∏à‡∏Ç‡∏ô‡∏≤‡∏î‡∏£‡∏ß‡∏°
  const total = Array.from(uploadDT.files).reduce((s,f)=>s+f.size,0);
  if (total > MAX_TOTAL_UPLOAD){
    alert('‡∏Ç‡∏ô‡∏≤‡∏î‡πÑ‡∏ü‡∏•‡πå‡∏£‡∏ß‡∏°‡πÄ‡∏Å‡∏¥‡∏ô 20MB ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏î‡∏à‡∏≥‡∏ô‡∏ß‡∏ô/‡∏Ç‡∏ô‡∏≤‡∏î‡πÑ‡∏ü‡∏•‡πå');
    // ‡∏ï‡∏±‡∏î‡∏•‡∏á‡πÉ‡∏´‡πâ‡∏û‡∏≠: ‡πÑ‡∏•‡πà‡∏•‡∏ö‡∏ï‡∏±‡∏ß‡∏™‡∏∏‡∏î‡∏ó‡πâ‡∏≤‡∏¢‡∏à‡∏ô‡∏Å‡∏ß‡πà‡∏≤‡∏à‡∏∞‡πÑ‡∏°‡πà‡πÄ‡∏Å‡∏¥‡∏ô
    while (Array.from(uploadDT.files).reduce((s,f)=>s+f.size,0) > MAX_TOTAL_UPLOAD){
      uploadDT.items.remove(uploadDT.files.length - 1);
    }
  }

  syncInputAndRender();
}

function syncInputAndRender(){
  // ‡∏ã‡∏¥‡∏á‡∏Å‡πå‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡∏ó‡∏µ‡πà <input> ‡πÉ‡∏´‡πâ‡∏™‡∏∞‡∏ó‡πâ‡∏≠‡∏ô‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î
  fileInput.files = uploadDT.files;
  renderPreviews();
}

function renderPreviews(){
  previewEl.innerHTML = '';
  Array.from(uploadDT.files).forEach((f, idx) => {
    const url = URL.createObjectURL(f);

    const wrap = document.createElement('div');
    wrap.className = 'relative aspect-square rounded-lg overflow-hidden border border-gray-200';

    // ‡∏£‡∏π‡∏õ
    const img = document.createElement('img');
    img.src = url;
    img.alt = f.name;
    img.className = 'w-full h-full object-cover';

    // ‡∏õ‡∏∏‡πà‡∏°‡∏•‡∏ö
    const btn = document.createElement('button');
    btn.type = 'button';
    btn.setAttribute('aria-label', '‡∏•‡∏ö‡∏£‡∏π‡∏õ');
    btn.className =
      'absolute top-1 right-1 rounded-md px-2 py-1 text-xs bg-black/60 text-white hover:bg-black/80';
    btn.textContent = '‚úï';
    btn.onclick = () => removeFileAt(idx);

    wrap.appendChild(img);
    wrap.appendChild(btn);
    previewEl.appendChild(wrap);
  });
}

function removeFileAt(index){
  if (index < 0 || index >= uploadDT.files.length) return;
  uploadDT.items.remove(index);
  syncInputAndRender();
}

async function collectImagesFromInput(){
  const input = document.getElementById('incidentPhotos');
  if(!input || !input.files || !input.files.length) return [];
  const files = Array.from(input.files).slice(0, MAX_FILES);
  const ok = files.filter(f => ACCEPTED_TYPES.includes(f.type) || f.type.startsWith('image/'));
  return Promise.all(ok.map(fileToBase64));
}
    // ===== Init =====
    showPage('report');
    
// ‡πÄ‡∏õ‡∏¥‡∏î/‡∏õ‡∏¥‡∏î‡πÅ‡∏ú‡∏á‡πÄ‡∏°‡∏ô‡∏π‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠
function toggleMobileMenu(nextState){
  const panel = document.getElementById('mobileMenu');
  const isHidden = panel.classList.contains('hidden');
  const shouldOpen = (typeof nextState === 'boolean') ? nextState : isHidden;
  panel.classList.toggle('hidden', !shouldOpen);
}

    function fileToBase64(file){
  return new Promise((resolve,reject)=>{
    const reader = new FileReader();
    reader.onload = () => {
      const s = String(reader.result || '');
      const m = s.match(/^data:(.+);base64,(.*)$/);
      if(!m) return reject(new Error('‡∏≠‡πà‡∏≤‡∏ô‡πÑ‡∏ü‡∏•‡πå‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à'));
      resolve({ name:file.name, mimeType:m[1], base64:m[2] });
    };
    reader.onerror = reject;
    reader.readAsDataURL(file);
  });
}
    
  </script>
  <!-- Loading Modal -->
<!-- Loading Modal (no blur, no dim, normal text) -->
<div id="loadingModal" class="fixed inset-0 z-[60] hidden">
  <div class="w-full h-full flex items-center justify-center">
    <div class="bg-white rounded-2xl shadow-2xl px-6 py-5 flex items-center gap-3">
      <svg class="w-6 h-6 animate-spin" viewBox="0 0 24 24" fill="none" aria-label="‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î">
        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
        <path class="opacity-75" d="M4 12a8 8 0 018-8" stroke="currentColor" stroke-width="4"></path>
      </svg>
      <span id="loadingText" class="text-gray-800">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á...</span>
    </div>
  </div>
</div>
  
</body>
</html>
